# 一、绪论

## 1 概念

网络包括计算机网络，电话网络等。

计算机网络是计算机技术和通信技术的结合，它将分散的、具有独立功能的计算机系统，通过通信设备与线路连接起来，由功能完善的软件实现资源共享和信息传递的系统，是一个互连的、自治的计算机集合。

计算机网络的功能：

最重要得到就是数据通信和资源共享。

* 数据通信

* 资源共享，包括硬件资源、软件资源、数据资源

* 分布式处理，即多台计算机共同承担一个工作任务的不同部分

* 提高可靠性，假如一台主机当机使这条链路走不通了，那另一条链路的主机可以成为它的替代机

* 负载均衡，即分布式处理达到的效果，一个工作均衡分配给各台计算机

## 2 计算机网络组成

组成部分：

* 硬件，主要包括主机（即端系统）、链路、通信设备

* 软件、即安装在端系统的软件，如系统程序的FTP，应用程序的QQ、微信

* 协议，计算机网络的核心，一系列规则和约定的结合，保证计算机网络安全平稳可靠的进行数据传输

工作方式：

分为边缘部分和核心部分

* 边缘部分即主机，即用户可以直接使用的，进行通信主要有客户端和P2P两种方式

* 核心部分，主要是为边缘部分服务的，包含大量路由器和网络

功能组成：

根据数据通信和资源共享分为通信子网和资源子网，分别实现数据通信和资源共享，也可以统一说成对数据的处理。

通信子网对应OSI七层模型的物理层-数据链路层-网络层

资源子网对应OSI七层模型的会话层-表示层-应用层

中间的传输层是两个子网的接口

## 3 计算机网络的分类

按照分布范围可以分为：

* 广域网（WAN），是一个很大的范围，通常会跨国，使用交换技术

* 城域网（MAN），覆盖一个城市

* 局域网（LAN），比较小的范围，如一个教室是一个局域网，使用广播技术

* 个人区域网（PAN），个人的电子设备互联的区域

按使用者可以分为：公用网和专用网

* 公用网主要有中国移动、中国电信、中国联通等

* 专用网，在军队、政府、银行等内部使用，必须具备权限才能使用

按交换技术可以分为：电路交换、报文交换和分组交换

按拓扑结构可以分为：总线型、星型、环型和网状型，拓扑结构指的是将网络中的设备抽象为一个点，链路抽象为一个直线形成的图

* 网状型通常用于广域网（如因特网）

* 星型的节点数=链路数+1；中间结点是控制中心，一条链路断了，其他还能工作但中间结点坏了整个链路就也都不能用了；任意两个结点的通信最多只需两步，速传输度非常快；网络构造简单，建网容易，扩展性强有新的计算机直接连上就行；总之星型便于控制和管理，但可靠性低，共享能力差，有单点故障问题

* 总线型可靠性高，共享能力强，结点间相应速度快，设备投入量少成本低安装方便，某节点故障对整个系统影响小

* 环型设备和链路比较节省，但有单点故障问题，只要结点宕机，整个链路就都无法使用了；闭环使得不便于扩充，相应时间长，传输效率低，传输方向无法改变

* 还有一种树型，易扩展易隔离故障，但有单点故障问题，一个结点宕机则它的子树搜不能用了，且传输方向无法改变

综上，总线型最优秀且成本也不高，是最常用的。

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-10-22-15-58-16-image.png)

按传输技术可以分为：广播式网络和点对点网络

* 广播式网络，指所有的主机可以共享一个通信信道，一台主机通过这个信道传输数据时，其他主机都可以接收到，每台主机会进行判断看目的地之是不是传输给自己的，若是就接收，不是就丢弃

* 点对点网络，使用分组存储转发和路由选择机制，一对一的通信

## 4 计算机网络标准化工作和相关组织

法定标准：

国内外规定的法定标准，如OSI七层模型

事实标准：

随着一些列的商业竞争，角逐出一些协议和标准就，成为了民间认可的事实上的标准，如TCP/IP协议

RFC（Request For Contents）：

因特网标准的一种形式，但不代表所有的RFC都是因特网标准。RFC要成为因特网标准需要经历3个阶段（2011年之前是4个阶段）：

1. 因特网草案，根据构思你定一个草案，以邮件的形式发给RFC

2. 建议标准，若草案不错，草案会成为RFC文档，随后就可以请求评论了，放到因特网上得到一些建议和修改，完善后得到草案标准，给相关组织审核

3. 成为因特网标准

标准化工作的相关组织：

* ISO（国际标准化组织），主要贡献是OSI参考模型和HDLC协议；

* ITU（国际电信联盟），主要贡献是指定了通信规则；

* IEEE（国际电气电子工程师协会），是一个学术机构，主要贡献是IEEE802系列标准，5G标准；

* IETF（Internet工程任务组），负责因特网相关标准的指定，如RFC；

## 5 计算机网络的性能指标

（1）速度指标

① 速率

表示计算机网络的快慢，通常指数据率（也叫数据传输率，比特率，发送速率，传输速率），速率即数字信道上传输数据位数的速率，单位有b/s，kb/s，Mb/s，Gb/s，Tb/s。也有bps，bps = b/s

比特（bit）：计算机数据的最小单位，一个比特代表0或1，速率单位是小写b小写k，如kb/s，Mb/s

字节（Byte）：1个字节 = 8个比特，速率单位是大写B大写K，其他不变，如KB/s，MB/s

此外，这里的速率单位之间是1000倍的关系而不是1024倍，在存储容量方面才是1024倍。

② 带宽

原先中是指某个信号剧透的频带宽度（最高频率与最低频率之差，单位hz），因为原先大多是传输模拟信号

但是现在大多数是传输数字信号，所以带宽的概念发生了变化，现在指的是网络的通信线路传输数据的能力，通常是单位时间内从网络某一点到另一点所能通过的最高数据率（也可以理解为网络设备支持的最高速度），单位和速率一样，单位之间也是1000倍的关系。

③ 吞吐量

单位时间内，通过某网络/信道/接口的数据量之和，单位和速率一样，单位之间也是1000倍的关系。

如CD传输数据到B，C的速率是10Mb/s，D的速率是20Mb/s，那么B的吞吐量就是30Mb/s

```
        | --- C
A --- B -
        | --- D
```

④ 总结

速率是单位时间能传多少数据，带宽是能够支持的最大速率，吞吐量是通过某个地方（这个地方可能有多条链路经过）的数据量之和（速率之和）。

（2）时间指标

① 时延

数据/比特流/报文/分组从链路一端到另一端的时间，单位s，分为四个部分

场景：A --- 路由器 --- B    A发送数据给B    

* 发送时延（也叫传输时延），A从发送分组到信道上的覅一个比特开始算起，到该分组的最后一个比特发送到信道完毕所苏姚的时间。
  
  公式：发送时延 = 比特数 / 速率  （但是做题时一般给的是带宽，所以做题要 * 带宽）

* 传播时延，电磁波在信道上传播的时间
  
  公式：传播时延 = 信道长度 / 电磁波速率  （电磁波速率由于阻力一般达不到光速）

* 排队时延，等待输出/输入到链路需要的时间，如这里输入路由器，路由器输出的时间，这段时间数据会存到路由器的缓存里

* 处理时延，数据检错纠错寻址的时间，如这里发生在路由器内部

减少时延的方法是提高发送速率或带宽，以此减少发送时延；而电磁波的速率一般变不了；所以高速链路指的是发送速率块。

总时延 = n * 发送时延 + 单个比特的传播时延 （n为比特数），视情况看是否需要加上处理时延和排队时延

② 时延带宽积

公式：时延带宽积  = 传播时延 * 发送带宽  （单位：s * bit/s = bit）

描述数据量/信息量的多少，即此时此刻在信道中的所有比特数，因此也称为以比特为单位的链路长度。

③ 往返时延RTT

发送方发送第一个比特到信道上开始，到发送方从信道上收到接收方第一个比特的确认为止的时间。RTT越大，收到确认之前可以发送的数据越多，因为等确认的时间久且会一直发送。

可以在终端ping一下得到RTT：

```
ping www.baidu.com
```

公式：RTT = 2 * 传播时延 + 末端处理时间  （注意不包括发送时延）

④ 利用率

* 信道利用率 = 有数据通过时间 / (有 + 无)数据通过时间

* 网络利用率 = 信道利用率加权平均值

利用率也不宜太高，否则会造成堵塞增大时延

## 6 计算机网络分层结构

计算机网络体系结构时各层及其协议的集合。

实体：每一层的活动元素，同一层的实体互为对等实体，第n层的实体叫n层实体

协议：一系列的规则或约定，只有对等实体之间才有协议

接口：每两层之间的关口

服务：每两层之间提供的东西，计算机网络中是上层使用下层的服务

分层基本原则：

* 各层之间相互独立，每层只能实现一种相对独立的功能

* 每层的界限清晰，易于理解，相互交流尽可能少

* 分层时，每层采用最合适的技术实现

* 保持下层对上层的独立性，上层单向使用下层的服务

* 分层结构应该能促进标准化工作

（1）七层OSI参考模型

法定标准的分层模型，但是市场使用以及用户体验没有四层模型好，所以很少使用

自下而上分别是：物理层-数据链路层-网络层-传输层-会话层-表示层-应用层

通信子网对应下三层，资源子网对应上三层。

（2）四层TCP/IP模型

自下而上分别是：网络接口层-网际层-传输层-应用层

（3）五层模型

结合七层/四层模型的优点得到的新分层模型

自下而上分别是：物理层-数据链路层-网络层-传输层-应用层

（4）TCP/IP协议栈

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-11-16-43-26-image.png)

## 7 网络通信过程与实际生活中的网络

（1）传输过程

A主机发送数据给主机B：

* 主机A，应用层，准备应用层报文

* 主机A，传输层，封装报文，如封装端口号信息，若报文太长会分成报文段

* 主机A，网络层，报文或报文段封装成IP数据报，若封装IP地址信息，若IP数据报太长会分成分组

* 主机A，数据链路层，IP数据报或分组封装成帧，如封装MAC地址信息

* 主机A，物理层，按比特流，一个个比特调制成信号放到信道上

* 比特流在信道上传输，载体为电磁波，电磁波速度大约是20万km/s

* 主机B，物理层，收到比特流，从物理层-应用层逐步拆封数据，最终找到主机B对应的应用

（2）网速

总时延 = 发送时延 + 传播时延 = n * 发送带宽 + 除数距离 * 电磁波速度 （n为比特数）

* 之所以无论多少个比特，传播时延都一样，是因为在比特流放到信道上的同时，前面比特也在信道上传输，只要最后一个体特被接收了，那之前的比特也被接收了。所以总的时延看总的发送时延加上最后一个比特的传播时延就能得出

* 所以平时生活中的网速，一般可以看做是略小于发送带宽。比如带宽为10Mb/s，一个人使用，不考虑干扰，下载10GB的文件，下载服务器距离为2000km，电磁波速度为20万km/s
  
  需要的时间 = 10 * 1024 / (10 / 8) + 2000 / 200000 = 4096 + 0.01 = 4096.01(s)
  
  可以看出传播时延几乎可以忽略，所以才说生活中的网速就是略小于带宽

* 不过，在一些需要实时交互的应用中，如游戏，就需要考虑传播时延了，因为这些应用是边接收边处理，而不是像上面那样先全部接收。这时候无论网速多快都会有延迟，如国外游戏，假设某国外游戏服务器距离玩家2000km，那传播时延 = 0.01s = 100ms，游戏中的延迟是往返时间，也就是200ms，在游戏中显示就是ping=200，延迟已经非常高了，这里还没有算上干扰情况。无论网速多快都无法解决，因为传播时延只收电磁波速度和距离影响

* 若听信双方发送带宽不同，则双方使用较小的那个发送带宽。
  
  * 在有上传下载等功能的应用中，服务器的发送带宽要非常高（Tb级别），才能保证大量用户同时上传下载，百度网盘限速的原因之一就是每个人分到的服务器发送带宽少，使得用户自己的发送带宽也变小了
  
  * 像博客网站这种，访问网站可能只需要请求过来几十KB的数据，即使服务器带宽不大，虽然用户的发送带宽也降下来了，也能保证可以在用户接受的时间内访问页面。所以1M的带宽也能保证几十到上百人的同时访问

# 二、应用层

网络体系结构的最上层，应用程序之间的通信。

规定：

* 需要规定应用进程的报文类型（请求报文/响应报文）

* 需要规定各种报文的语法

* 需要规定字段的语义，以及包含在字段中的信息的含义

* 需要规定进程何时、如何发送报文，以及对报文相应的规则

功能：

* 文件的传输、访问和管理，协议有FTP，TFTP

* 电子邮件，协议有SMTP，POP3，IMAP

* 虚拟终端，协议有HTTP

* 查询服务和远程作业登录，协议有DNS

## 1 网络应用模型

（1）客户/服务器模型（Client/Server）

把网络的节点分为客户机和服务器两种角色，客户机就是用户使用的计算机，用户可以请求服务器的服务；服务器就是提供服务的计算机。

服务器特点：

* 永久提供服务

* 永久性的访问地址/域名

客户机特点：

* 与服务器通信，使用服务器的服务

* 间歇性接入网络

* 可能使用的是动态的ip地址

* 不与其他客户机直接通信，需要借助服务器转发

（2）P2P模型（Peer-to-peer，也叫对等模型）

没有服务器，只有主机，整个网络传输的内容都不会保存到服务器上，每个主机都具有上传和下载的功能，它们的权利和义务都是对等的。

特点：

* 没有永久的服务器

* 主机都可以提供服务和请求服务

* 主机之间可以直接通信

* 主机都可以间歇性的接入网络

* 主机可能使用动态的ip地址

* 可扩展性好，不像服务器有容量限制

* 网络健壮性强，不容易瘫痪，不像服务器瘫痪了整个服务都瘫痪了

# 2 域名解析系统DNS

客户机是通过ip地址找到服务器的，但是ip地址不好记，所以就有了域名。域名是ip地址的一个别名。比如 www.baidu.com 就是一个域名

域名由数字、字母、点等构成，用点分隔出一个个标号，如com就是一个标号，每个标号最多不能超过63个字符（为了方便也不要超过12个字符），每个标号不区分大小写。标号的等级从右至左，级别由高到低，分别是顶级域名，二级域名，三级域名......

此外，顶级域名之上还有一个根，根一般省略不写，如 www.baidu.com 的完整写法是 www.baidu.com.  最后面的点后面就是根。

顶级域名分类：

| 顶级域名分类         | 说明                                                                                        |
| -------------- | ----------------------------------------------------------------------------------------- |
| 国家顶级域名         | 如cn，us，uk等，分别是中国、美国、英国等                                                                   |
| 通用顶级域名         | com（公司企业），net（提供信息的机构），org（非营利性组织），gov（政府），int（国际组织），aero（航空企业），museum（博物馆），travel（旅游业）等等 |
| 基础结构域名（也叫反向域名） | arpa，用ip地址反向解析为域名                                                                         |

二级域名分类：

这里的二级域名也可以作为顶级域名

| 二级域名分类         | 说明                                                                    |
| -------------- | --------------------------------------------------------------------- |
| 类别域名           | ac（科研机构），com（工商金融），edu（教育），gov（政府），mil（中国国防），net（提供信息的机构），org（非营利性组织） |
| 行政区域名          | 各个省市等的域名                                                              |
| 自己注册的二级域名或三级域名 | 必须全球唯一，如 baidu                                                        |

顶级域名和二级域名有重复的部分，是用于顶级域名为国家级域名的场景，如 org.cn

域名树：

根作为根结点，顶级域名为第二层，以此类推构成一个域名树，书写域名时，从最低级开始书写。

因为使用了域名，计算机就需要有一个将域名解析为ip地址的功能，这就是DNS（域名解析系统）。通过DNS服务器来解析域名。

DNS服务器：

* 在域名树上的DNS服务器有：根域名服务器，顶级域名服务器，权限域名服务器，全球共有13个根域名DNS服务器（域名分别是 a.rootserver 到 m.rootserver），一个权限域名服务器对应一个区（如 abc.com 和 x.abc.com 分别对应两个区的两个权限域名服务器，abc 和 x.abc 是同级的）

* 不在域名树上的DNS服务器：本地域名服务器（也叫默认域名服务器），离主机最近（不超过几个路由器），本地域名服务器的存在可以使距离比较近的主机通信可以直接诶在本地域名服务器内解析，而不用进入域名树查询

解析过程：

1. 操作系统检查缓存和本地的hosts文件，看该url是否有记录ip地址，有的话就完成解析；否则就继续下一步。

2. 使用TCP/IP参数中设置的DNS服务器进行查询，如果查找的域名包含在本地配置区域资源中，则返回解析结果完成解析；否则继续下一步。

3. 检查本地DNS服务器是否缓存该url记录，有就完成解析；否则继续下一步。

4. 到此处，就分为迭代查询和递归查询两种方式了，无论哪种方式，查到结果后都会高速缓存到本地域名服务器和主机中，缓存会定期更新。
   
   * 迭代查询（靠自己），本地DNS服务器发送查询报文到根DNS服务器，根DNS服务器收到后，返回顶级根DNS服务器地址，随后本地DNS服务器发送查询报文到顶级根DNS服务器，顶级根DNS服务器返回权威DNS服务器的地址，随后本地DNS服务器再发送请求报文到权威DNS服务器，权威DNS服务器收到后就会返回最终的ip地址，完成解析。
   
   * 递归查询（靠别人），本地->根->顶级->权限（得到ip地址）->顶级->根->本地

## 3 文件传输协议FTP

TFTP（简单文件传输协议）：内存占用小且易于实现，面向小文件的传输协议。适用于UDP环境，如需要将程序/文件同时给许多机器下载时就用到TFTP；还适用于小型计算机或特殊用途的设备

FTP：

基于客户/服务器模型的协议，可以提供不同种类的主机系统（硬件/软件都可以不同）之间文件传输的能力，如windows系统传文件给Linux系统。FTP功能有上传和下载。客户机可以连接远程的FTP服务器并遵循FTP协议传输文件

FTP传输模式：文本模式（ASCI），二进制模式（Binary）

FTP工作原理：

1. 登录FTP服务器，输入FTP服务器的ip地址、用户名和密码。此外，互联网上也有很多匿名的FTP服务器可以匿名登录，

2. 建立TCP连接，客户机和FTP服务器是可以多对多，且FTP服务器的一个进程也可以为多个客户机的进程服务。FTP进程由唯一的主进程和n个从属进程组成
   
   * 唯一的主进程：负责接收新的请求
   
   * n个从属进程：每个从属进程都可以为一个客户机进程服务。控制进程和数据进程也属于从属进程

3. 主进程打开FTP服务器的熟知端口21，控制进程在21端口建立控制连接->等待客户机发起连接请求（发给服务器的控制进程）->客户进程连接熟知端口->打开从属进程->传输数据（与服务器的数据进程在20端口建立数据连接），控制连接是一直连接的，而数据连接只有传输数据时才连接。数据连接如果是主动模式就是20端口，被动模式就由客户和服务器协商决定（通常大于1024）
   
   * 主动模式：建立连接找到熟知端口21，主动告诉客户机在服务器的端口20建立数据连接
   
   * 被动模式：建立连接找到熟知端口21，随后客户机发送一个命令给服务器，询问服务器的数据连接端口号，客户机在用这个端口建立数据连接

## 4 电子邮件

（1）电子邮件的信息格式

* 信封，包括收件人的邮箱等）

* 内容，包括首部（发给谁和主题等），和主体

（2）电子邮件系统的组成结构

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-10-27-01-08-27-image.png)

* 用户代理：用户和电子邮件系统的接口，通常是邮箱程序，功能是提供给用户撰写、显示、处理、通信四个功能

* 邮件服务器：功能是邮件服务器之间发送和接收邮件（因此邮件服务器可以充当客户/服务器两种角色），和报告给发件人传送结果。

* 协议：SMTP和POP3、IMAP
  
  * SMTP：在客户发送邮件到邮件服务器，邮件服务器发送邮件给邮件服务器时使用
  
  * POP3和IMAP：在邮件服务器接收，客户机接收时使用

（3）电子邮件系统工作原理

* 发送方通过用户代理写邮件，并发给发送方的邮件服务器的缓存里（SMTP协议，TCP连接）

* 若发送方邮件服务器可以发送了，就从发送方的邮件服务器缓存中取出，并发送给收件方的邮件服务器的缓存里（SMTP协议，TCP连接诶）

* 若接收方邮件服务器可以发送了，从缓存取出，发给收件方用户代理，用户代理接收（POP3协议或IMAP协议，TCP连接）

（4）电子邮件的协议

① MTP（简单邮件传送协议）

使用TCP连接，端口号25，使用客户/服务器模型

规定了在两个相互通信的SMTP进程之间应该如何交换信息。

负责发送邮件的SMTP进程SMTP客户，负责接收邮件的SMTP进程就是SMTP服务器。每个邮件服务器可以作为客户也可以作为服务器。

SMTP规定了14条命令（每个命令由几个字母组成）和21中应答信息（3位数字+简单英文说明）。

SMTP之间的通信，分三个阶段：

1. 建立TCP连接：发送方写邮件，发送到发送方的SMTP服务器缓存中
   
   * 发送方SMTP服务器每隔一段时间扫描一次缓存，若发现有邮件就是要SMTP协议，25端口与接收方的SMTP服务器建立TCP连接
   
   * 接收方SMTP服务器发出应答信息220 Service ready 表示可以传输了
   
   * SMTP客户向SMTP服务器发送一个helo命令，并附上发送方的主机名
   
   * SMTP服务器若有能力接收，就发 250 ok 给SMTP客户；若三天内不能接收邮件，就发回 421 Sevice not availble

2. 传送邮件：
   
   * A发送 MAIL FROM 和 发件人邮箱，B成功就返回 250 OK，失败返回451
   
   * A发送一个或多个RCPTTO命令，和发件人邮箱，B成功就返回 250 OK，失败返回550
   
   * A发送DATA命令，表示可以正式发送邮件了，B返回354
   
   * A发送Date，发邮件，B接收，B接收
   
   * A发送完，发CRLF 表示传输结束，B返回 250 OK，传输结束

3. 连接释放：A发 QUIT 命令，B返回 211 ，释放连接

SMTP缺点：

* 不能传输可执行文件或其它的二进制对象

* SMTP只支持7位比特的ASCI，也就是说不能传除了英语之外的语言

* SMTP服务器会拒绝一定长度的邮件

为了解决这些缺点，就有了MIME（通用因特网邮件扩充）：

在SMTP协议上扩充邮件内容长度的一种手段，且会将非ASCI的内容转为ASCI，支持可执行文件，音乐，多种语言。目前MIME也应用于浏览器。

② POP3协议（邮局协议）

在接收邮件时使用，TCP连接，端口号110，客户/服务器模型，接收方邮件服务器作为POP3客户，用户代理作为POP3服务器。

两种工作方式：

* 接收方邮件服务器从缓存读取出来邮件后，下载并继续保留

* 接收方邮件服务器从缓存读取出来邮件后，从缓存中删除

不管是下载还是删除，都不是很方便，所以在后期也使用MIME进行扩充

③ IMAP协议（网际报文存取协议）

由于POP3功能有限，就有了IMAP协议。

当用户主机的IMAP程序打开IMAP服务器的邮箱时，用户先可以看到邮件首部，只有要打开邮件时，才会上传到主机。并且用户可以在不同地方不同主机打开邮件的某个部分，需要的时候再查看其它部分或下载附件

（5）基于万维网的电子邮件

目前使用的邮件方式，进入网站就可以直接使用电子邮件

* 发送方用户代理到发送方邮件服务器不再使用SMTP协议，而是http协议

* 发送方邮件服务器到接收方邮件服务器还是SMTP协议

* 接收方邮件服务器到接收方用户代理使用IMAP协议

## 5 万维网和http协议

### 5.1 万维网

万维网（www，World Wide Web）

客户/服务器模型，万维网是大规模的，联机式的信息储藏所，是全球的网站、网页的集合。如果需要访问这些资源，就需要url（统一资源定位符），url唯一标识万维网的资源。万维网通过HTML能很方便跳转界面，并在屏幕上显示出来

url格式： 协议://主机:端口/路径

* url不区分大小写

* 常用的协议有ftp协议，http协议，https协议

* 主机就是域名，也可以直接写ip

* 端口号可以省略，省略后位80

通过点击超链接或浏览器输入url，通过http协议就能访问资源

### 5.2 http协议

http协议（超文本传输协议）

详细规定了浏览器和万维网服务器之间互相通信的规则，主要是规定了请求(request)和响应(response)两块内容。

浏览器向服务器发送请求，发送内容是请求报文，服务器响应返回的内容是响应报文。

（1）用户点击超链接或输入url后的过程

* DNS解析

* 与服务器80端口建立TCP连接

* 发送http请求，服务器返回文档

* 显示文档（可以只下按时部分资源，如视频可以播放再请求过来）

* 释放TCP连接

（2）http协议特点：

* 无状态：每次进入网页都是初始内容；但是实际使用中，可能需要状态保持，如保持登录状态。此时可以使用本地的cookie文件保存状态

* 使用TCP连接，但是http协议本身是无连接的，在http请求和相应之前不需要建立http连接

* http协议的TCP连接有持久连接和非持久连接，持久连接又分为流水线式的持久连接（可以同时发请求，相应会依次返回）和非流水线的持久连接（一个请求有相应之后才能继续发请求）

（3）http协议报文结构

分为http请求报文和http相应报文

请求报文结构：

开始行又叫请求行，首部行又叫请求头，只有回车的哪一行是请求空行必须有的，实体主体又叫请求体。

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-10-27-01-10-48-image.png)

相应报文结构：

开始行又叫相应行，首部行又叫相应头，只有回车的哪一行是请求空行必须有的，实体主体又叫相应体。

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-10-27-01-11-40-image.png)

请求鲍文文示例：

Conection: close 表示非持久连接

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-10-27-01-12-54-image.png)

状态码：

| 1xx | 服务器收到，需要请求者继续执行 100:服务器收到POST的Header，需要请求者再发送data |
| --- | ------------------------------------------------- |
| 2xx | 表示成功，一般是200                                       |
| 3xx | 重定向，需要进一步操作来完成请求 301:资源/网页被永久转移到其他url             |
| 4xx | 客户端错误，请求有语法错误或无法完成请求 404:请求的资源/网页不存在              |
| 5xx | 服务器错误，服务器在处理请求过程中发生错误 500:内部服务器错误                 |

请求方式：

有post、put，get、delete等，分别对应增改查删（CURD）

GET和POST是最常用的两种请求类型。
http协议层面上看基本区别：

1. 都是http的请求方式，底层都是TCP/IP协议

2. 通常GET产生一个TCP数据包，POST产生两个TCP数据包。在网络好的情况下，发一个两个数据包速度没有太大差异，GET/POST都可使用；但是在网络差的情况下，GET可定比POST速度快。

3. GET会把Header和data一起发送，服务器返回200则成功；POST先发送Header，等服务器返回100后再发送data，服务器返回200则成功。

4. GET请求通常通过url来获取数据，POST请求通常通过表单来发送数据

5. GET请求和POST请求都可以传递参数

使用上的区别：

1. 最本质区别：GET的参数包含在url，POST的参数在请求体中

2. GET请求参数有大小限制且只能接受Ascll编码的数据且格式只能url编码，POST请求参数没有大小限制且没有数据的类型限制且有多种格式(也支持url编码)

3. GET参数显示在url上，安全性隐私性差，不适合传递敏感数据，POST在请求体中更安全

4. GET请求会保留在浏览器历史记录中且可bookmark(收藏/书签)，而POST不会

5. GET请求在刷新/回退网页时，无影响；而POST会再次发送请求，因此GET效率更高

6. GET请求会被缓存，POST请求不会被缓存，所以GET效率更高

（4）http协议版本

http1.1最常用，http2是比较新的版本

http1.1之后，请求默认都是流水线的持久连接

早期的http都是非持久连接，所以每次请求都要反复建立断开连接，非常消耗性能。在1997年http1.1发布之后加入了持久连接，只需要建立一次连接在里面进行多次的请求响应，不需要重复建立断开连接，提升了数据传输的效率。

此外，http1.1还推出了流水线式的持久连接（管道机制），在一个连接中可以并发发送多个请求，但是响应不是并发的。http2后响应也是并发的。

（5）https协议

https请求则会在TCP和http之间多添加一层协议作为加密以及认证的服务。https使用SSL和TLS协议保证信息的安全。

SSL协议：认证客户端和服务器，确保数据发送到正确的客户端和服务器，加密数据并维护数据的完整性。

TSL协议：用于在两个通信应用程序之间，提供保密性和数据完整性。TSL由TSL记录协议和TSL握手协议组成。

# 三、传输层

二进制反码求和，TCP，UDP，IP协议等中计算检验和都会用到：

先求和，若最高位出现了进位，则该进位回滚到最低位与结果相加（没有用到反码不知道为什么叫反码求和）

```
    1 0 0
+   1 0 0
= 1 0 0 0  ->  结果有进位，需要回卷

    0 0 0
+       1
    0 0 1   
```

## 1 基本概念

传输层是网络结构的第四层，是主机之间才有的层次，而路由器等网络设备最多只到地三层网络层。传输层为应用层提供服务，使用网络层的服务。

功能：

* 提供进程与进程之间的逻辑通信（逻辑是指表面看起来是主机之间通信，实际上是从应用层一直封装到物理层，进行传输，接收方再从物理层解封到应用层）

* 复用和分用：复用指发送方不同的应用进程会使用同一个传输层的协议进行传输，分用指接收方在剥去报文首部后能够正确地送交给正确的进程

* 对收到的报文进行数据的差错检测

传输层协议：

* TCP协议，协议字段为6

* UDP协议，协议字段为17

传输层的寻址与端口：

通过端口号寻址，端口号是传输层的ICP（服务访问点），唯一标识本机的进程，这里的端口是软件（逻辑）端口，要与实际中插拔的硬件端口区分开。每个端口用数字标识，叫端口号，长度为16比特，即范围为0-65535。端口号大小可以分类为：

* 服务端使用的端口号，又可以分为两类：
  
  * 熟知端口号：0-1023，标识TCP/IP最重要的进程
  
  * 登记端口号：1024-49151，标识重要性较小的进程

* 客户端使用的端口号，49152-65535，只有在使用时才会随机分配，因此这些端口号可以循环利用，动态选择。

比较重要的熟知端口号：

| FTP | TELNET | SMTP | DNS | TFTP | HTTP | SNMP |
| --- | ------ | ---- | --- | ---- | ---- | ---- |
| 21  | 23     | 23   | 53  | 69   | 80   | 161  |

套接字：是主机ip地址和端口号的组合，可以唯一标识网络中的主机以及该主机的进程。

## 2 UDP协议

UDP协议（用户数据报协议）

在ip数据报的基础上加了一点功能，如复用分用，差错检测。

（1）特点

* 无连接，是不可靠的。传输数据不需要建立连接，收到UDP报文后也不需要给确认。由于不需要连接，所以时延小。适用于小文件。

* 使用最大努力交付，即不可靠的交付，由应用层保证可靠性

* 面向报文，即对于应用层传下来的报文不合并也不拆分，不改变报文的长度。适合一次性传输少量数据的网络应用，如果报文太长会导致网络层需要更多的分片，效率变低。且由于UDP不可靠太多数据也容易丢失。

* 没有拥塞控制，但是也带来了好处，即使网络优点拥塞了也会先丢弃一些数据保证继续传输，适用于实时应用如直播、饰品会议等。如果拥塞比较严重也可以向前纠错或重传报文。

* UDP首部只有8个字节，首部开销小

（2）UDP数据报结构

8字节首部字段+数据字段，数据字段可以没有，也就是UDP数据包最小可以为8个字节。

源端口号可有可无，如果需要目的端口回复就添上，不需要源端口号全0即可。

目的端口号必须要有。

UDP长度是珍格格UDP数据报的长度，即首部+数据部分的长度。

UDP检验和是检验整个UDP数据报是否出错，若出错就丢弃该UDP数据报；还有一种出错就是UDP数据报分用时找不到对应的端口，此时也会丢弃UDP数据报，并发送ICMP端口不可达的差错报告报文给发送方。

数据部分是应用层的报文。

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-10-27-19-45-20-image.png)

（3）UDP检验和检验的过程

在UDP数据报的首部内最前面加上一个伪首部。伪指的是类似ip数据报的首部。伪首部仅仅只会存在于UDP校验的过程中，不会向上递交/向下传输。

伪首部中的17是表示UDP协议的协议字段。

伪首部中的UDP长度是首部+数据部分，但是不包括伪首部的长度。

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-10-27-19-47-29-image.png)

校验过程：

1. 拼接伪首部，伪首部+首部+数据部分每4个字节划分一部分

2. 全0填充校验和字段

3. 数据部分最后面若不足4个字节就填充全0变成4个字节

4. 伪首部+首部+数据部分所有4个字节进行二进制反码求和

5. 得到的结果再取反码，得到检验和，得到的检验和填充到首部的检验和的位置

6. 去掉伪首部，开始发送UDP数据报到接收方

7. 到了接收方后加上再次伪首部

8. 伪首部+首部+数据部分所有4个字节进行二进制反码求和

9. 若计算结果为全1，就说明没差错；若不为全1就丢弃UDP数据报或附上警告交割应用层处理，由应隐藏做差错控制

为什么全1就没出错呢？看下面的例子：

```
设发送方反码求和的只有100和100两个，和一个全0的检验和
    0 0 0  ->  检验和
    1 0 0
+   1 0 0
= 1 0 0 0  ->  结果有进位，需要回卷

    0 0 0
+       1
    0 0 1 
001求反码得到检验和110

接收方进行反码求和
    1 1 0  ->  检验和
    1 0 0
+   1 0 0
= 1 1 1 0  ->  最高位有进位，需要回卷

    1 1 0
+       1
=   1 1 1  ->  全1，没有出错  
```

## 3 TCP协议

面向连接的传输控制协议，是可靠的，传输前建立连接，传输网释放连接，不提供广播/多播服务。由于需要提供可靠的传输，就会有一些时间和性能开销，如回复确认，流量控制，计时器，连接管理等。适用于大文件。

特点

* 面向连接，建立虚连接（逻辑上的连接，而不是物理存在的）

* 每条TCP连接只能有两个端点，是点对点的。无法实现多播和广播

* 提供可靠的交付服务，可以使报文段无差错、不丢失、不重复、按序到达

* 可以提供全双工通信。由于两端都可以发送和接收数据，所以收发双方都有发送缓存和接收缓存，发送缓存存放未放到链路发送的准备发送的数据和已发送但在等待接收方确认的数据，接收缓存中按序到达但还未被应用程序读取的数据和没有按序到达的数据

* TCP是面向字节流的，以字节为单位传输，也可将多个字节放到一个报文段中，依次传输报文段，报文段有几个字节由数据链路层的MTU决定

### 3.1 TCP报文结构

包括首部和数据部分，数据部分即应用层的报文

首部结构：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-10-30-01-03-10-image.png)

首部包括20字节的固定首部和可变长度的选项，整个首部的大小范围时20字节-60字节

固定首部所有内容必须有（不像UDP的源端口可以没有）

整个首部必须是4n个字节，若选项部分不足4n字节需要填充全0

序号，表示该报文段所发送数据的第一个字节的序号

确认号：接收方期望收到到发送方下一个报文段的第一个数据字节的序号，若确认号为n，则说明序号n-1及之前的数据都已经收到

数据偏移：TCP报文段的数据起始处距整个TCP报文段的起始处还有多少4字节，即整个首部的字节数。在TCP报文首部中含有选项时，长度就不确定，就需要数据偏移记录下来，如1111表示首部有15*4=60字节

控制位：

| 控制位 | 说明                                                                 |
| --- | ------------------------------------------------------------------ |
| URG | 紧急位，URG=1时，那就不用再发送缓存中排队，可以优先发送                                     |
| ACK | 确认位，ACK=1时确认号才有效，所有传输的报文ACK都应该置为1                                  |
| PSH | 推送位，PSH=1时，接收方会优先交付给对应的应用程序而不用等到接收魂村满了再交付                          |
| RST | 重置位，RST=1时，表示TCP连接中出现了严重差错，必须释放连接，然后再重新建立连接；此外还表示拒绝非法的报文段或拒绝打开一个连接 |
| SYN | 同步位，SYN=1时，表示这是一个建立TCP连接的请求                                        |
| FIN | 结束位，FIN=1时，表示发送方数据已发完，需要释放连接                                       |

窗口：发送本报文段的一方的接收窗口，也就是现在允许对方发送的字节数。另一方可以根据这个字节数来确定自己发送缓存的大小。如A发送数据给B，那A有一个接收窗口数值位65535，表示可以接收B返回65535个字节，那B的发送缓存就可以设置为65535字节。

检验和：和UDP一模一样，也是需要添加伪首部和二进制反码求和再反码

紧急指针：URG=1时才有意义，表示紧急数据的字节数（紧急数据从第一位开始算），如紧急指针为50，就表示数据部分第1位到第50位是紧急数据

### 3.2 TCP的连接管理

有连接建立、数据传输、连接释放三个阶段。

TCP的两个端点是客户/服务器模型，发起连接的为客户，同意连接的为服务器，双方都可以发送/接收数据。

（1）三次握手建立连接

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-10-30-01-01-53-image.png)

1. 客户端发起连接请求，发送没有数据部分得到连接请求报文段，控制位SYN=1，ACK=0，序号sep=x（客户机随机产生x值）

2. 服务器收到连接请求报文段，若服务器个条件都允许，就给分配发送/接收缓存，并返回没有数据部分的确认报文段，控制位SYN=1，ACK=1，序号seq=y（服务器随机产生y值），确认号ack=x+1

3. 客户机收到服务器的确认报文，为自己分配发送/接收缓存，并需要发送确认的确认报文给服务器，此时的确认报文可以携带数据进行传输了，控制位SYN=0，ACK=1，序号seq=x+1，确认号ack=y+1

随后就可以一直传输数据了。

SYN洪泛攻击：在三次握手时，黑客进行大量的第一次握手发送SYN，服务器第二次握手返回确认，但是黑客不进行第三次握手使得TCP连接一直挂起而无法完成连接，使得服务器一直发送ACK确认，占用大量服务器资源使得服务器宕机。防范方法是设置SYN cookie。

（2）四次挥手释放连接

TCP连接双方都可以随时中止连接，中止连接后，缓存和变量都会释放。

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-10-30-01-00-18-image.png)

1. A发送连接释放报文段给B，控制位SYN=0，FIN=1，seq=u

2. B收到，返回SYN=0，FIN=0，ACK=1，seq=v，ack=u+1，此时连接变为半关闭状态，A不用回复这一步的确认

3. B再发一个连接释放报文段，SYN=0，FIN=1，ACK=1，seq=w，ack=u+1

4. A收到，返回SYN=0，FIN=0，ACK=1，seq=u+1，ack=w+1

四次挥手后，等待计时器设置的2MSL（最长报文段寿命）后，连接才会完全释放，彻底关闭。之所以要等待2MSL的时间，是为了防止第四次挥手的报文在传输时丢失，B若未收到确认会重传一个第三次挥手的报文，A收到后再次发送确认报文并充值2MSL，直到B收到为止。

### 3.3 TCP的可靠传输

网络层是尽最大努力地交付，但不可靠的传输方式，所以传输层就需要承担可靠传输的职能。可靠指的是保证接收方进程从缓存中读出的字节流与发送方发送的字节流是完全一样的，即按序不丢失不出错。

共有四种实现可靠传输机制：

* 检验：和UDP的一样，不再赘述

* 序号：TCP传输的是字节流，按字节为单位传输，每个字节标一个序号。发送的数据第一个序号可以是随机的，随后的每个序号都是上一个序号+1。报文段中有了序号就可以保证有序的传输

* 确认：确认机制在序号机制的基础上就能很好的实现有序传输。假设现在要传输三个报文段，报文段里面的字节的序号分别是：123，456，78，接收方收到报文段123后，回复发送方的报文中的确认号为4，发送方就可以根据确认号4直到自己要发送报文段456。随后，若接收方没有收到456，那接收方就恢复确认号4，让发送方重传456.若传完123后，同时传了456和78，接收方收到了78但456没收到，那恢复的确认号也是4，发送方需要重传456,78则收到了不用重传。

* 重传：发送方发送数据后，会一直缓存该数据在发送缓存中，若传输出现了丢失需要重传，就继续重传缓存中的数据，根据确认号就知道是否要重传。另一种是超时重传。

超时重传：在规定时间内，发送方没有收到确认，就需要重传，这个时间叫重传时间。由于每个报文段传输的路径以及网络情况都不相同，使得重传时间不好确定，若太短，则则一些不会丢失的报文段还未到达就要重传，若太长，则会增大网络的空闲时间而降低效率。传输层通过采用自适应的算法来动态改变重传时间，这个重传时间叫RTTs（加权的平均往返时间），RTT是从发送到收到确认的往返时间的意思。发送第n个报文时，有一个RTT，根据第n个的RTT，第n-1个报文的RTT，...第2个报文的RTT，第一个报文的RTT全部加权平均算出RTTs。超时重传需要在重传时间内一直等，若到了时间还没有确认就需要重传，但是等的时间可能有点久，可以通过冗余ACK（也叫冗余确认），比如传输4个报文12,34,56,78qizhong 34丢失，那么接收方收到12,56,78时，回复的确认号都是3，也就是发送方收到了好几个冗余的确认号3，就知道34丢失了需要重传34。因为一般情况下这个收到冗余ACK的时间比重传时间短，所以也叫快速重传。

***

滑动窗口：分为发送窗口和接收窗口，1个单位放一个帧，当发送/接收完一个帧后，向后滑动，继续发送后面的帧。如下图黄色区域是某发送窗口：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-01-18-09-16-image.png)

若发送窗口没有收到确认，滑动窗口就不会滑动，窗口内都是原来的帧，相当于变相控制了传输速率，实现了流量控制。

可靠传输的协议有停止-等待协议和滑动窗口协议，滑动窗口协议又包括后退N帧协议（GBN协议）和选择重传协议（SR协议）。

注意，在不同的书中，这3个协议有可能放到数据链路层，也有可能放到传输层，原因是计算机网络发展的早期，通信链路质量不是很好，那个时候就需要数据链路层承担可靠传输的职能，因此就会使用这3个协议；而随着技术的发展，现在的通信链路质量越来越好，出现差错的可能性就很小了，所以现在的数据链路层可以不用管可靠传输只需要差错控制就行，而可靠传输交给传输层解决，这样的好处是使得数据在链路上传输的速率更快，耗时更少。

若要分析链路层的可靠传输和流量控制，就把报文段换成帧，字节流换成比特流，......等等

***

信道利用率：发送方在一个发送周期内，有效地发送数据所需时间占整个发送周期的比率，公式： (L / C) / T   L为比特数，C为发送速率，T为发送周期=发送时延+接收时延+RTT

信道吞吐率：信道利用率 * 发送速率

***

为了方便，在分析这3个协议的时候，只认为只有一端发送一端接收，用编号表示每个包含多个有序号字节流的报文段，以A代表发送方，以B代表接收方。

### 3.3.1 停止-等待协议

也可以看作是特殊的滑动窗口协议，特殊在发送/接收窗口都是1。

每发送完一个帧就停止发送，等待对方确认并自己收到确认后，再发送下一个帧。可以看出这种协议的传输效率非常低。

每次只发送一个报文段并缓存，因此只需要一个比特（0和1两个编号）就能给每个报文段编号。

在应用中的两种情况：

* 无差错的情况：A发送报文段0并缓存报文段0，B接收并返回确认ack0，A发送报文段1并缓存报文段1，B收到报文段0并返回确认ack1，然后A发送报文段0并缓存报文段0......，注意前后的报文段0是不同的报文段。

* 有差错的情况：A发送报文段0并缓存报文段0，但是报文段0传输的时候丢失，或到达B但是因为出错了把它丢弃，或无差错接收但ack0丢失或ack0迟到，此时就不会返回ack0。当A长时间收不到确认，会触发超时重传。超时重传的原理是，每次发送一个报文段都会启动一个定时器（时间要大于往返时间RTT，因为发送/接收报文段会有发送/接收时延），并缓存该报文段，当超时时就可以从缓存中取出并重传。由于超时重传是自动执行的，所以也叫自动重传。
  
  报文段丢失/丢弃、确认丢失都会超时重传；却认迟到则不理会延迟的确认。

优缺点：

* 优点：简单

* 缺点：信道利用率低，= 发送时延 / (发送时延+RTT+接收时延)，提高发送时延就能提高信道利用率，发送时延随发送比特数提高，也就有了GBN协议和SR协议

### 3.3.2 后退N帧协议

也叫GBN协议。滑动窗口协议的一种。发送窗口大于等于1，接收窗口等于1。

基本流程如下：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-01-18-14-07-image.png)

接收方收到0后返回ACK 0

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-01-18-13-01-image.png)

右移接收窗口，发送帆收到ACK 0后右移发送窗口

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-01-18-11-07-image.png)

发送窗口连续地按序发送报文段，看起来像流水线所以又叫流水线技术。

发数据存共有四个部分：

* 未在窗口内但已发送，这些数据已经传输完毕

* 在窗口内已发送但未确认

* 在窗口内且未发送

* 未在窗口内且发送，存在于发送缓存或还在应用层中，等待窗口滑过来时再发送

发送方需要做的事：

- 给上层（应用层）调用，调用时先检查发送窗口是否已满，准备放入报文段n，若未满则放入，若已满就退回报文段n，等窗口滑动后空出再放入。当然在实际中，发送缓存比滑动窗口大，所以若发送窗口满了而发送缓存未满会把报文段n放入发送缓存

- 收到ACK确认x后，说明x及之前的所有报文段均已接收，发送窗口右移并发送新的报文段

- 超时重传，与停止-等待协议不同的是GBN协议每个报文段超时都会触发重传，重传的是发送窗口内，已发送但未确认的报文段。

接收方需要做的事：

- 若正确按序接收报文段x，则返回确认ACK x，然后把x交给上层（应用层），接收窗口右移

- 因为接收窗口只有1又要实现按序接收，所以若未收到某个报文段，则其后的所有报文段即使到了接收端也会全部丢弃，如已收到1,2，但未收到3，那忠厚的4，5，6。。。全部丢弃，并返回确认ACK 2

- 累积确认：接收方不必对每一个接收都返回一个确认，可以隔一会再返回一个确认，如在一段时间内收到了1、2、3，则只需要返回ACK3即可

- 捎带确认：若接收方想发送数据给发送方，可以放到确认里面一起传输。

发送窗口的大小有限制，若使用n个比特对报文段编号，，则大小范围为 1 <= w <= 2^n-1 如2个比特编码，以01230123012301230123...编号，窗口大小最多为3，可以看出如果窗口太大的话窗口内就会出现重复的编号，就无法区分了。

优缺点：

- 优点：信道利用率高

- 缺点：接收窗口只有1，未收到x会丢弃x之后的所有报文段，浪费资源。此外，累积确认虽有好处，但是也造成了需要批量重传的问题

---

习题：

GBN协议，发送方发送了0-7，收到了0、2、3的确认，则超时重传几个？

解：收到了3的确认，说明3之前已经全部接收并返回确认，ACK 2没有收到肯呢个是丢失或延迟，但也没有关系，因为2一定收到了。所以需要重传的是45678，共5个。

### 3.3.3 选择重传协议

也叫SR协议。滑动窗口协议的一种。发送窗口和接收窗口都大于等于1。

基本流程如下：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-01-18-18-56-image.png)

发送窗口连续地乱序发送报文段。

发送数据共有5个部分：

* 未在窗口内但已发送，这些数据已经传输完毕

* 在窗口内已发送但未确认

* 在窗口内已发送且已确认，带带窗口下界发送并确认后在一起滑动

* 在窗口内且未发送

* 未在窗口内且未发送，存在于发送缓存或还在应用层中，等待窗口滑过来时再发送

接收数据共有5个部分：

* 未在窗口内但已接收，这些数据已经传输完毕，交付给应用层，并从接收缓存中清除

* 在窗口内且未接收

* 在窗口内但已接收，放入接收缓存，等待窗口下界接收完放入接收缓存再一起滑动

* 未在窗口内且未发送，等待窗口滑过来时再接收

发送方需要做的事：

- 给上层（应用层）调用，调用时先检查发送窗口是否已满，准备放入报文段n，若未满则放入，若已满就退回报文段n，等窗口滑动后空出再放入。当然在实际中，发送缓存比滑动窗口大，所以若发送窗口满了而发送缓存未满会把报文段n放入发送缓存

- 收到ACK确认x后，只说明x已接收，如果此时发送窗口中x之前均已确认，则窗口右移到第一个未确认处并发送新的报文段，否则窗口不动继续等待确认

- 超时重传，与停止-等待协议不同的是GBN协议每个报文段超时都会触发重传，只重传这个超时的报文段

接收方需要做的事：

* 需要接收缓存

* 在接收窗口内的接收，来者不拒，不管顺序，都会返回ACK

* 若接收后未失序，则交给应用层并窗口右移；若失序，则缓存起来，直到接收到按序的报文段再一起交给应用层并窗口右移

* 若收到滑动之前的地方，接收窗口大小的额区域的报文段，则说明之前返回的ACK丢失了导致发送方重传，此时只需要再次返回对应的ACK即可

* 没有累积确认，都是收到一个就返回一个确认；可以稍待确认

发送窗口与接收窗口的大小：最好一样，发送窗口大于接收窗口会来不及接收，小于有没有意义。 大小范围都是  1 <= w发送 = w接收 <= 2^(n-1)   n为几个比特编码，如2个比特编码012301230123...，窗口最大为2。

优缺点：

* 优点：信道利用率高，该接收的都会接收，重传时会选择重传

* 缺点：复杂

***

习题；

SR协议，发送0-3，已确认1，而0和2超时，超时重传几个？

解：3不知道有没有超时，所以不考虑，因此需要重传0和2，共2个

### 3.4 TCP的流量控制

虽然我们希望数据传输可以快一点，但是若传的太快，接收方来不及接收，就会产生严重的丢包现象，所以我们需要流量控制，来控制发送方的发送速率。

通过滑动窗口机制实现流量控制：

接收方会根据自己接收缓存的大小，通过确认报文段的窗口字段来控制发送方的发送窗口大小。

注意，传输层的窗口字段大小，是以字节为单位，而不是以报文段数量为单位。

一般流程如下：

* 建立连接成功时，初始的窗口字段捎带在确认报文段中，发送方的发送窗口就可以根据这个窗口字段来设置发送窗口的大小

* 在以后的传输过程中，若接收方需要改变发送方发送窗口的大小，会把窗口字段捎带在数据报文段或确认报文段中

* 若接收方满了需要交给应用层，需要一定的处理时间，这时候就会返回窗口字段为0，表示发送方的发送窗口为0，暂时不能发数据，并且发送方会启动一个定时器。当接收方空闲再返回窗口字段让发送方继续发送，若该窗口字段传输时丢失了那定时器就起作用了，定时器超时就会发送一个报文段给接收方，让接收方重新返回窗口字段，其实就是超时重传

### 3.5 TCP的拥塞控制

拥塞：网络状况不好，使得发送/接收数据速度变慢，当对资源的需求 > 可用资源就会产生拥塞，资源主要是链路的带宽、缓存、路由器等。

拥塞控制的目的就是控制发送窗口防止过多的数据输入到网络中，过程中需要协调网络中的所有主机。

发送窗口同时受流量控制和拥塞窗口的控制，发送窗口大小取接收窗口和拥塞窗口字节数较小的那个值。

* 这里说的接收窗口（RWND）指的是接收方的接收能力，单位是字节数

* 拥塞窗口（CWND），为了研究方便单位是n个MSS（最大报文段长度），n是报文段数量，与接收窗口比较时需要注意要比较字节数

都是较少发送的数据量，那与流量控制的区别是：

* 研究问题不同：流量控制是点对点的问题，而拥塞控制是全局的问题

* 需求不同：流量控制是解决发送太快导致的接收不过来的问题，而拥塞控制解决的是网络拥塞导致的数据发送/接收速率慢的问题

* 流量控制中发送窗口由接收方决定，而拥塞控制中发送窗口由发送方决定

拥塞控制的具体算法：

为了研究方便，设只有一端发送一端接收，接收缓存足够大使发送方发送窗口不用考虑流量控制只考虑拥塞控制

（1）慢开始和拥塞避免两种算法

x轴为传输轮次，y轴为拥塞窗口（CWND）大小。

传输轮次：发送n个报文段到全部确认为一轮，或者发送n个报文段到下次发送m个报文段开始这段时间也行，为了方便也可能一个RTT就认为是一轮。

慢开始算法：

* 初始时拥塞窗口只有1，随后根据每一个传输轮次不断探查，若网络状态良好，则收到该轮最后的确认报文段后就指数级增大拥塞窗口（2倍），再发送新一轮的报文段

* 当拥塞窗口大小达到ssthresh的初始值（慢开始门限），就说明拥塞窗口有些大了，担心之后会发生拥塞，就需要把拥塞窗口的增大速度降下来，执行拥塞避免算法

拥塞避免算法：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-01-18-00-34-image.png)

* 每次只在之前的拥塞窗口大小基础上加法级（+1）的增大

* 当加到出现拥塞情况时，计算当前拥塞窗口/2，作为新的慢开始ssthresh的值，并把拥塞窗口较少到1，继续执行慢开始算法

（2）快重传和快恢复两种算法

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-01-18-02-02-image.png)

快重传：收到3个及以上的多余重复/冗余的确认，就会执行块重传算法，比如收到4个相同的确认，后面3个就是多余重复的，就会执行快重传算法

快恢复：在慢开始和拥塞避免的基础上，只要执行了块重传，计算当前拥塞窗口/2，作为新的慢开始ssthresh的值，并把拥塞窗口较少到ssthresh，继续执行拥塞避免算法

### 3.5 TCP的拥塞控制

# 四、网络层

## 1 基本概念

网络层传输单位：IP数据报和分组，分组是IP数据报切割后的产物

（1）功能

把分组从源段发送到目的端，为分组交换网上的不同主机提供通信服务，主要功能呢个如下：

* 路由选择与分组转发：通过路由选择算法寻找最佳路由，将分组发送出去

* 异构网的互联：通过路由器连接，如3G/4G/5G/有线/无线等

* 拥塞控制：开环控制（静态的，在网络工作之前就先把所有能够产生拥塞的因素都考虑到进行预先控制），闭环控制（动态的，网络运行时自动去调整）

## 2 数据交换方式

分为电路交换，报文交换和分组交换。

数据交换就是各个路由器/交换机之间的数据交换，这是因为在实际生活中不可能将大量的主机连接在一个路由器中，有的主机卢丽媛且路由器端口也没有那么多，此时就需要多个路由器，每个路由器连接少量的主机，通过路由器之间进行数据交换实现通信。

### 2.1 电路交换

电路交换的应用之一是电话网络，通过拨号建立连接，双方通过连接就可以通话，通话过程中信号会经过电话网络的交换设备。

电话挂断后，连接释放，连接释放后别人就可以使用这些空闲的资源。

电路交换的连接建立后，通信路径就是固定的且即使不说话始终独自占用该资源，连接的信道带宽比较大时会造成资源的浪费，此时可以采用多路复用（划分信道，详见数据链路层）的方案。

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-10-18-54-29-image.png)

优缺点：

* 优点：因为是固定的连接，就带来了一系列优点，通信时延少，有序传输，没有冲突，实时性强

* 缺点：建立连接时间较长，连接独占资源所以利用效率低，灵活性差如一方宕机整条链路就没用了，没有差错控制能力

### 2.2 报文交换

一整个应用层的报文，如整个PDF文件，到传输层如果报文太长会分割为报文段，到网络层加上ip地址等，链路层加上MAC地址等，到物理层上传输。

传输时，报文会到一个存储转发的设备（如交换机），报文到了交换机后先存储起来，等待链路空闲可用时再转发出去，转发到哪里取决于但是链路的情况，因此传输路径时不确定的。

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-10-18-55-24-image.png)

优缺点：

* 优点：不需要建立连接诶，使用存储转发可以动态分配路径且使得链路利用率高，链路可靠性高当一条链路换了还可以选择另一条链路，可以提供多目标服务（可以发给多个和目的地址）

* 缺点：有存储转发时延，报文大小不定所以需要交换设备有较大的缓存空间

### 2.3 分组交换

与报文交换的思想差不多，都是存储转发，区别在于分组交换转发的数据大小和具体是什么是不固定的，分组交换转发的是分组。

报文交换传输的是整个分组，而分组交换传输的是一个个从报文分割出来的分组，两者比较一下，报文交换就像是串行的，分组交换就像是并行的。

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-10-18-56-07-image.png)

优缺点：

* 优点：在报文交换优点的基础上，信道利用率更高因为每个分组都可以在不同路径上传输，存储管理更容易（如缓存不需要很大）

* 缺点：有存储转发时延，需要传输多余的信息量因为每个分组需要标识信息，乱序到达囧受访时需要排序重组的时间

对比报文交换和分组交换，总体上还是分组交换时延要少一些，比如下面的例题：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-10-18-56-57-image.png)

例题：报文长度10000bit，可以分割为等长的分组，每个分组10bit，每条链路的发送速率（即数据传输速率）均为1000bit/s，求报文交换和分组交换从开始发送到完全接收各自需要的最少时间。

解：由题目给出的条件，可以得出题目不考虑传播时延/排队时延/处理时延/报文和分组的首部开销，要求算出最少时间，由图中抗议看出最少时间就是只经过两个交换机，再犹豫每条链路的传输速率相同，所以总的时间 = 主机发送时延 + 2个交换机的发送时延 = 3倍主机的发送时延

报文交换最少时间 = 10000bit / 1000bit/s * 3 = 30s

分组交换最少i时间 = 10bit / 1000bit/s * 1000个分组 + 2 * 10bit / 1000bit/s = 10.2s

解释：需要注意的是，报文交换和分组交换最少时间求法不同的本质是，报文交换在每次经过交换机时，交换机都要等到全部接收完报文后才能转发出去；而分组交换则不同，每个分组到达交换机后都能单独转发出去而不需要等待全部接收完，这样就使得当发送方发送完最后一个分组，该分组经过两个交换机的发送时延到达接收方后，接收方其实已经接收全部分组了，所以可以总结出分组交换的时间 = 发送方发送所有分组的时延 + 最后一个分组经过的交换机的发送时延之和

做这种类型得到题目时，需要注意一下几点：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-10-18-58-37-image.png)

电路交换、报文交换、分组交换的选择：

* 电路交换不需要存储转发，所以时延最少，当通信的时间远大于建立连接的时间时，选择电路交换

* 其他情况选择分组交换

分组交换又可以细分为两种：

* 数据报方式的分组交换：为网络层提供无连接服务，不建立连接，每个分组的路径可能不同，分组可能不会按照序到达，解决方法是给每个分组编号，根据编号就可以按照顺序重组
  
  因特网使用的就是数据报方式

* 虚电路方式的分组交换：为网络层提供连接服务，建立一个虚拟的电路连接，传输的分组路径都是一样的，分组会按序到达，传输结束后释放该连接，相当于分组交换和电路交换的结合

* 两者的区别总结；
  
  |           | 数据报方式             | 虚电路方式               |
  | --------- | ----------------- | ------------------- |
  | 是否建立连接    | 否                 | 是                   |
  | 路由选择      | 每个分组独立进行路由选择和转发   | 每个分组按同一路由来转发        |
  | 是否按序到达    | 否                 | 是                   |
  | 目的地址      | 每个分组必须要有源地址和目的地址  | 每个分组都不需要目的地址，需要虚电路号 |
  | 可靠性       | 不可靠，可靠性由用户保证      | 可靠，可靠性由网络保证         |
  | 差错处理和流量控制 | 用户负责              | 分组交换网负责             |
  | 网络故障的适应性  | 若网络某节点故障，也可以走其他的路 | 只要某个节点故障，整个路径都不能工作了 |

## 3 IP协议

### 3.1 IP数据报

（1）IP数据报和分组的格式：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-11-16-41-35-image.png)

首部格式：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-11-16-39-18-image.png)

20字节固定长度和40字节的可变长度，若首部长度不是4字节的整数倍，就要填充0。

版本：IO协议的版本，有IPv4和IPv6

首部长度：共4位，它的值*4字节是实际的长度，因为首部是20字节的固定长度，所以最少是0101（5）

区分服务：期望获得哪种类型的服务（如优先发送），若不使用则可忽略

总长度：首部+数据部分，它的值*1是实际的总长度

标识、标志、片偏移：用于分片为分组

生存时间：也叫TTL，IP数据报或分组的保质期，每经过一个路由器会-1，值为0时会丢弃该IP数据报或分组。这是为了防止无法交付的IP数据报或分组无限制地在网络中兜圈子。

协议：数据部分使用的协议

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-11-16-32-08-image.png)

首部检验和：只检验首部，方法噶为二进制反码求和

其中，最需要注意的是首部长度，总长度，片片偏移的值分别对应4个字节，1个字节，8个字节。

（2）IP数据报分片成分组

数据链路层中，最大传输单元MTU要求帧的数据部分不超过1500字节，也就是网络层的IP数据报的首部+数据部分不超过1500字节，超过了就要分片成分组，当然也必须IP数据报统同意分片，否则就会返回ICMP的差错报告报文。

分片分的是IP数据报的数据部分。

分片需要使用首部的标识、标志和片偏移：

* 标识：同一个IP数据报的分片使用相同的标识

* 标志：共3位，最高位目前没有用。中间位DF（1禁止分片，0允许分片），最低位MF（1后面还有分片，0后面没有分片了或不需要分片的IP数据报）

* 片偏移：该分片在原来IP数据报数据部分中的起始位置，它的值*8字节是实际位置，从0开始

实例：

假设数据链路层的MTU = 1420，那分组的长度最长就是 20字节首部 + 1400 = 1420

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-11-16-30-31-image.png)

分组1的数据部分对应原IP数据报数据部分的0-1399字节，片偏移 = 0

分组1的数据部分对应原IP数据报数据部分的1400-2799字节，片偏移 = 1400 / 8 = 175

分组1的数据部分对应原IP数据报数据部分的2800-3799字节，片偏移 = 2800 / 8 = 350

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-11-16-29-35-image.png)

### 3.2 IP地址

唯一标识网络中的各个主机、设备、接口等。

#### 3.2.1 IPv4

IPv4地址共32位，写作点分十进制，每8位用点隔开，如 192.168.1.1

IPv4地址的32位分为网络号和主机号两部分，路由器一个端口连接的网络是一个独立的广播域，里面各个设备的网络号是一样的。

IPv4地址按照历史的发展分为：分类的IP地址，子网划分的IP地址，构成超网的IP地址

（1）分类的IP地址

分类是因为每个网络差异比较大，有的网络主机多，有的网络主机少。

分为ABCDE五类：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-14-12-48-58-image.png)

D类地址作为多播地址，用于一对多通信。

E类地址为备用

然而并不是所有IP地址都可以使用的，其中有一些特殊的IP地址：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-14-12-50-19-image.png)

ABC类地址除去这些特殊IP地址后，可用的IP地址如下：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-14-12-52-40-image.png)

私有IP地址：只能在私有的内部安洛中使用如学校机房，互联网是不认识的，私有IP地址通过NAT与外部通信，每个类别的私有地址范围如下：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-14-12-51-02-image.png)

NAT（网络地址转换）：

在连接专用网和因特网的路由器上安装NAT软件，此路由器就变为NAT路由器，它至少有一个有效的外部IP地址，内部的主机与外部通信时都需要NAT路由器进行地址转换。

NAT路由器会维护一个NAT转换表，如内部网地址为192.168.x.x，外部IP地址为172.38.1.5：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-15-04-47-23-image.png)

当内部网主机发送的数据报到达NAT路由器时，就会用外部IP的对应端口替换掉内部的主机源地址和端口号。

而外部的主机发送数据报给内部网的主机时，目的地址是NAT路由器的IP地址，当数据报到达NAT路由器后，将目的地址转换为私有地址和对应的端口号。

（2）子网划分的IP地址

未分类的IP，分类的IP，划分子网的IP分别也叫一级IP，二级IP，三级IP。

分类的IP地址有一些缺点：

* IP地址的利用率不合理，如A类地址主机号非常多，一定是用不完的

* 不够灵活，如主机号不够还需要去申请新的网络号

在分类的IP地址基础上进行子网划分，子网划分就解决了这些问题。若某单位要划分子网，是这个单位内部划分的，是否/如何划分都由这个单位决定。划分子网后，对外部仍然表现为一个网络号，也就是外部式不知道这个单位组合划分子网的。

子网划分是将主机号再划分为子网号和主机号，网络号+子网号构成网络地址：

* 主机号不能全0全1，所以至少需要留下两位作为主机号，如果只有一位的话就是主机号全0全1的特殊IP了

* 一般情况下子网号不能全0全1，但是在构成超网中可以，所以n位子网号可以划分2^n或2^n-2个子网

子网掩码：

用于标识网络地址，IP地址的网络号和子网号为1，主机号为0就构成子网掩码，如B类IP地址的网络号为171.16.0.0，用两位主机号作为子网号，那它的子网掩码就是255.255.192.0。

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-15-04-51-03-image.png)

注意：同一个IP地址，不同的子网掩码得出的网络地址可能一样，但是它们的子网划分方式是不同的，可用的主机数也不同

根据子网掩码算出网络地址：

路由器将IP地址与子网掩码按位与即可，如IP地址为171.16.66.0，子网掩码为255.255.192，按位与得到171.16.64.0，子网号为01，就知道属于哪个子网了。

路由器哦根据子网掩码进行转发的过程：

1. 每个路由器维护一个路由表，有目的地址/子网掩码/下一跳三列数据，下一跳是下一个要跳转的位置

2. 路由器根从分组中取出目的IP地址和子网掩码并按位与得到网络地址，若路由器连接有对应的网络地址则可以直接交付（可以直接转发到路由器连接的某个子网），若没有则间接交付（需要跳转下一个路由器）

3. 在间接交付前，看目的地址在路由表是否与特定主机路由的目的地址相同，若有则按照路由表的规则转发，没有则到间接交付

4. 间接交付时，先将目的IP与路由表中的每一个子网掩码按位与，若有对应的网络则按照下一跳跳转，若你没有则看是否有设置默认路由，若没有设置则不转发了

5. 默认路由IP地址和子网掩码都是0.0.0.0，直接发给下一个路由器，若下一个路由器没有对应的网路就把分组转发回来，循环往复这个步骤直到找到目的网络或到达生存事件TTL把分组丢弃

***

习题1：IP地址141.14.72.24，子网掩码255.255.192.0，求网络地址？若子网掩码为255.255.224.0，网络地址又是多少？

解：由题可知此IP为B类地址，两种子网掩码按位与得到网络地址141.14.64.0，也就是说同一个IP地址，不同的子网掩码得出的网络地址可能一样，但是它们的子网划分方式是不同的，可用的主机数也不同。

习题2：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-15-04-48-32-image.png)

解：D，按位与得到网络地址180.80.72.0，广播地址是主机号全1，也就是180.80.79.255

（3）构成超网的IP地址

构成超网基于五分类编址，也叫CIDR或五分类域间路由选择。

抛弃了分类地址，CIDR采用网络前缀+主机号的形式，如171.41.55.64/24表示网络前缀有24位作为网络前缀，其他8位作为主机号。子网掩码（CIDR中也叫地址掩码）1的个数为网络前缀的个数，CIDR子网掩码和IP地址按位与可得到网络前缀。

* CIDR主机号也不嗯能够全0全1

* CIDR子网号可以全0全1

CIDR地址块：相同网络前缀同属于一个地址块，如 171.41.56.12/24：

* 该地址块用最小地址表示，或用 /24 地址块表示

* 最小地址为主机号全0，最大地址为主机号全1，地址数 = 2 ^ 主机号位数，地址范围从171.41.56.0到171.47.56.255

* 但是最小最大地址不能作为IP地址，主机号全0全1分别是本网络和广播，即这里最小可分配地址为171.47.56.1，最大可分配地址为171.47.56.254，可分配地址数为2^5-2=30

地址块划分子网：

* 定长子网划分：每个子网IP数相同，网络前缀也相同。如x.x.x.x/24划分2个子网，它们的最小地址分别是x.x.x.0/25和x.x.x.128/25

* 变长子网划分：每个子网的IP数各有不同，网络前缀也各有不同。具体有什么划分方案可以画一个二叉树，如图是 /24 地址块 可划分的方案：
  
  ![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-15-03-38-16-image.png)
  
  可以划分为：
  
  2个子网，0和1，网路前缀分别是25、25
  
  3个子网，00、01和1，网路前缀分别是26、26、25
  
  3个子网，0和10/11，网路前缀分别是25、26、26
  
  4个子网，00、01、10、11，网路前缀分别是26、26、26、26
  
  其中划分为2个子网和4个子网其实都属于定长子网划分，可以得出结论划分出2^n个子网都属于定长子网划分，其他属于变长子网划分。
  
  若知道了最小地址块有n位子网号，则说明其他子网的子网号位数都是<=n，画出i一个n+1层的二叉树能很容易找出其他子网的划分方式

构成超网：

也叫路由聚合，将多个子网聚合成一个较大的子网，构成超网是为了减少路由表的冗余，如下面的例子：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-15-04-32-55-image.png)

CIDR的路由表只有目的地址和下一跳两列，如图R2连接了两个网络，若不做处理那R1的路由表就有两个下一跳为R2的路由信息，比较冗余，此时可以构成超网将路由信息合为一条，方法是找出最长公共前缀，其他补0，本例中公共前缀是206.1，即路由聚合后的地址为206.0.1.0/16，可以看出路由聚合是子网划分的逆过程。

需要聚合比较多的路由时，技巧是先找出字节开始出现不同的位置，再列出该字节的最大值和最小值就能很容易找出相同的前缀，如：

聚合121.45.x.x，121.46.x.x......121.59.x.x，第二个字节开始不同，45二进制是00101101，59的二进制是00111011，前三位001相同，就可以的出聚合路由为121.32.0.0/11

路由聚合后，

***

习题1：CIDR地址为192.199.170.82/27，问最小地址，最大地址，地址数？

解：最后一个字节二进制为01010010，前三个字节共24位加上该字节前三位等于27位作为网络前缀,。前三个字节不用管，最后一个字节主机号全0位01000000，全1位01011111，即最小地址为192.199.170.64，最大地址192.199.170.95，地址数为 2 ^ 5 = 32

习题2：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-15-04-36-20-image.png)

解：B，要划分5个子网，至少需要3个子网号，题目需要求最小子网，那我们就让左子树尽量大‘，可以分为0、10、110，但是还差2个，那就画多一层子树，得到1110、1111，就够5个子网了，因为我们左子树一直取最大的，所以最后得到的1110和1111一定是最小子网，即可用的IP数为：2^(32-20+4)-2 = 254 

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-15-04-11-14-image.png)



习题3：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-15-04-37-13-image.png)

解：B，根据子网掩码得出主机号其中5位作为子网号，3位作为主机号，由于CIDR子网号可以全0全1，主机号不能全0全1，所以子网数=2^5=32，主机数=2^3-2=6

习题4：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-15-04-40-51-image.png)

j解：B，132.19.237.5/8的网络号为132.0.0.0/8，132.19.237.5/11的网络号为132.0.0.0/11，132.19.237.5/22的网络号为132.19.236.0/22，即AB都复合，选网络前缀更长的

#### 3.2.2 IPv6

#### 3.2.3 移动IP

## 4 网络层其他协议

## 5 路由算法和路由选择协议

## 6 网络层设备——路由器

# 五、数据链路层

## 1 基本概念

（1）概念

数据链路层负责通过一条链路从一个结点向另一个物理链路直接相连的相邻结点安全无差错地传送ip数据报。

* 结点：主机和路由器，相邻的结点叫相邻结点。

* 链路：网络当中两个结点的物理通道，传输介质在物理层笔记里介绍。

* 数据链路：网络两个结点的逻辑通道，把实现数据传输协议的硬件和软件加到链路上就构成数据链路。

* 帧：数据链路层的的协议数据单元，封装网络层的数据报

（2）功能

数据链路层在使用物理层提供的服务基础上，向网络层提供服务，其最基本的服务就是将来自网络层的数据可靠地传输到相邻结点的目标机网络层。其主要作用是加强传输原始比特流的功能，将物理层提供的可能出错的物理连接改造为逻辑上无差错的数据链路，使之对网络层表现为一条无差错的链路。

* 为网络层提供无确认无连接服务、有确认无连接服务，有确认面向连接服务

* 链路管理，阶连接建立、维持和释放的过程，用于面向连接的服务

* 组帧

* 流量控制

* 差错控制，包括帧错、位错

（3）广域网与局域网

① 广域网

广域网：物理范围很大，从几十公里到几千公里，连接多个城市多个国家，或全世界，如互联网。

广域网的子网使用分组交换的技术，子网可以利用公用分组交换网、卫星通信网和无线分组交换网，将不同区域的局域网或计算机系统连接起来，达到资源共享的目的。

通过节点交换机连接各个局域网，与交换机不同的是节点交换机的功能是转发分组，与路由器不同的是节点交换机只能在单个网络中转发分组，而路由器可以在多个网络之间转发分组。

---

② 局域网

局域网：某一区域内，由多台计算机互联成的计算机组，使用广播信道。

与广域网的区别：

* 广域网覆盖物理层、数据链路层和网络层。局域网覆盖物理层和数据链路层。

* 广域网普遍采用点对点链路，全双工或半双工，局域网普遍采用多点接入技术，如总线型。

* 广域网传输速率比局域网快，但是广域网距离比较远使得传播延迟高，所以广域网强调资源共享，局域网强调数据传输。

* 广域网链路层的协议有PPP协议和HDLC协议，但是都只适用于全双工；局域网链路层的协议有CSMA/CD等介质访问控制协议

局域网的特点：

* 覆盖的地理范围比较小，只在相对独立的局部范围内互联，如一个办公室、一个教室、一个学校，覆盖范围在几千米之内

* 使用专门铺设的传输介质进行联网，传输速率比较快

* 通信延迟时间短，误码率低，可靠性高，原因是局域网速度快，就使得延迟少，进而收到的噪声少

* 各个站点平等，会共享信道

* 多采用分布式控制和广播式通信，能广播、组播

局域网的特点实际上是由网络拓扑、传输介质和介质访问控制决定的：

* 网络拓扑：总线型，星型，环型，树型

* 传输介质：传输介质分为有线（双绞线，同轴电缆，光纤）和无线（电磁波）

* 介质访问控制：CSMA/CD，令牌总线，令牌环

局域网分类：

* 以太网：应用最广泛，逻辑上是总线型，物理上是星型或拓展星型。包括标准以太网，快速以太网，千兆以太网和10G以太网，都复合IEEE802.3规范。介质访问控制方法是CSMA/CD

* 令牌环网：逻辑上是星型，物理上是环型。造价高且不实用，现在很少用

* FDDI网：光纤分布式数据接口，逻辑上为环型，物理上是双环。传输介质为光纤，造价高，现在很少用

* ATM网：星型单元交换技术，使用固定长度的单元（53字节）进行信息交换

* 无线局域网（WLAN）：IEEE802.11标准，传输介质是电磁波，wifi是无线局域网的其中一种应用

IEEE802标准：

由IEEE委员会制定的有关于局域网和城域网的一系列技术标准，802是指1980年2月开始成立的，最重要的标准有：

* IEEE802.3：规定以太网介质访问控制协议和物理层技术规范，以太网也叫802.3局域网

* IEEE802.5：令牌环网

* IEEE802.8：光纤技术咨询组，在FDDI网使用

* IEEE802.11：无线局域网

MAC子层和LAC子层：

IEEE802描述的是OSI参考模型的物理层和数据链路层，IEEE把数据链路层分为逻辑链路层（LAC子层）和介质访问控制（MAC子层）

LAC子层：逻辑上的链路控制子层，紧挨着网络层，功能：

* 负责识别网络层的协议并封装它们，LAC报头可以告诉链路层收到的帧做什么处理

* 还会为网络层提供服务，包括无确认无连接，带确认无连接，面向连接，高速传送

MAC子层：处理传输媒体相关的内容，紧挨着物理层，功能：

* 帧的封装和卸装，帧的寻址和识别，帧的接收与发送，帧的差错控制，链路的管理

* 屏蔽不同物理链路的差异性

---

③ 以太网

以太网（Ethernet），是基带总线局域网规范，是当前局域网采用的最通用标准，介质访问呢控制协议为CSMA/CD。

特点：

* 以太网网卡便宜，使得以太网造价低。比ATM完和令牌环网组网/建网/扩网/排除故障便宜、简单的多

* 应用已经非常广泛

* 可以满足当今网络速率的要求

以太网标准：

* DIX Ethernet V2：第一个局域网产品/以太网规约

* IEEE802.3

两个标准的区别在于帧的格式上，有2个字节的不同。只要满足其中一个标准就可以叫以太网。

以太网提供的无连接不可靠服务；

无需建立连接；只需实现无差错的接收，无序号、无确认，出错的帧丢弃，可靠传输交给传输层实现。

以太网传输介质和拓扑结构的发展：

* 传输介质：粗的同轴电缆->细的同轴电缆->双绞线与集线器

* 物理拓扑：总线型->星型

* 逻辑拓扑：一直是总线型

10BASE-T以太网：

* 10（10Mb/s），BASE（基带传输），T（双绞线，通常是无屏蔽双绞线）。

* 物理拓扑星型，每条双绞线最长100米；逻辑拓扑总线型

* 编码方式是曼彻斯特编码

* j介质访问控制协议是CSMA/CD

高速以太网：

速率大于等于100Mb/s的以太网。主要包括：

* 100BASE-T以太网：支持全双工和半双工，在全双工中没有冲突所以不用CSMA/CD

* 吉比特以太网：光纤/双绞线上传输1Gb/s的信号，支持全双工和半双工，在全双工中没有冲突所以不用CSMA/CD

* 10吉比特以太网：在光纤上传输10Gb/s的信号，只支持全双工，没有冲突所以不用CSMA/CD

适配器和MAC地址：

适配器也叫网络适配器或网卡，作用是将计算机与外界的有线局域网连接。早期的网卡是外接的，发展到现在是嵌入在主板内。网卡中有处理器和存储器（RAM和ROM）。

ROM中，有一个MAC地址，也叫计算机硬件地址或物理地址，是全球唯一的，标识该计算机，MAC地址是不可变的。

MAC地址共48位，写为6组每组2个，共12个16进制数。前24位代表厂家，由于IEEE规定，后24位由厂家自己指定。

以太网的MAC帧格式：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-08-17-31-50-image.png)

目的地址有3种：

* 单波地址：即目的主机的MAC地址

* 广播地址：全1，发送给所有的主机

* 多播地址

类型：标明网络层使用什么协议。

数据部分长度可变，范围：46字节-1500字节，其实就是最小帧长和MTU。

由于以太网使用曼彻斯特编码，发送时电压一定会变化，不发送时电压一定不变化，且每个帧之间会有最小间隔，因此只需要有开始的定界符，不需要结束的定界符

与IEEE802.3帧格式的区别是：类型字段在IEEE802.3帧中是长度或类型，长度或类型小于0x0600时，数据必须装入LAC子层。

---

④ 无线局域网

标准是IEEE802.11，规定的内容全部是无线局域网，下辖的扩展标准也是为了无线局域网。

wifi是无线局域网的一种，无线局域网的范围是几千米，而wifi的范围很小，wifi由802.11b和802.11g规定。

无线局域网分类：

* 有固定基础设施的局域网：基础设施为基站（也叫无线接入点），记为AP，基站的作用是实现一个区域内的各个主机之间相互通信，也可以实现漫游，漫游指的是不同基站的主机之间的通信；每个基站覆盖的范围构成了一个基本服务级（BSS），通过有线的分配系统实现服务级之间的漫游，也就是整个系统是无线+有线。用户在进入到某个基站范围时，会注册到该基站的数据库中，如手机从深圳外进入到深圳内某基站X，手机就会注册到X中，作为X范围内的用户

* 没有固定基础设施的自组织网络：没有任何的转发器、路由器、基站等，只有主机组成的网络，每个主机都是平等的且可以移动，都可以充当主机和路由器来发送数据/转发数据。只需要把所有主机安排在一个网段就可以组网

802.11的MAC帧的帧头格式；

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-08-17-32-18-image.png)

802.11共有4种帧，每种帧的帧头中的地址字段时不同的：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-08-17-30-29-image.png)

RA：接收基站的MAC地址，也可以用服务级ID（BSSID）代替

TA：发送的基站MAC地址

DA：接收主机的MAC地址，也是目的地址

SA：发送主机的MAC地址，也是原地址

无线局域网的主机通信分为基站内核跨基站（漫游）：

* 基站内：帧为IBSS，基站不需要转发给其他基站，只需发给基站内的其他主机即可，所以地址只需要DA、SA和BSSID

* 漫游：以分别处于两个基站范围的主机A和B为例，A发送数据给B需要通过A的基站AP1转发给B的基站AP2，AP2再发给B，过程就是 A->AP1->AP2->B
  
  * A->AP1：帧为To AP，地址只需要AB主机的MAC地址和AP1的ID
  
  * AP1->AP2：帧为WDS，地址需要AB主机的MAC地址和AP1，AP2的MAC地址
  
  * AP2->B：帧为From AP，地址只需要AB主机的MAC地址和AP2的ID

记忆方法：

* 地址1是下一个接收端的地址，地址2是此次发送端的地址，地址3和地址4看情况

* DA和SA一定有，剩下的就BSSID和RA+TA选一种

## 2 组帧

（1）组帧的概念

也叫封装成帧。

将ip数据报加头加尾，封装成帧再交付给物理层进行传输。ip数据报就成为帧的数据部分，接收端可以通过帧的首部和尾部的标记从收到的比特流中识别出帧的开始和结束（这个过程叫帧同步），标记就是首部和尾部的一个字段或一个字节，这个字节叫帧定界符。

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-10-30-01-12-01-image.png)

首部+ip数据报+尾部 = 帧长，为了提供传输效率数据部分长度要尽可能大于首部+尾部，但由于数据链路层的协议都会滚定数据部分的最大上限，叫做MTU（最大传送单元），不同的协议MTU都不同。

（2）透明传输

计算机网络中说的透明与实际生活中的透明看得见，这里说的透明是指看不见。

透明传输指的是不管所传的数据是怎么样的组合都应该能在链路上传送，因此链路层就好像看不见有什么妨碍数据传输的东西。

若果所传的比特中恰巧与某一个控制信息完全一样，那就要采取一定的手段和措施使得接收方不要将这个数据误认为是某种控制信息，这样才能保证数据链路层的传输是透明的。

（3）封装成帧的4种方法

这四种方法其实都有透明传输的思想。其中零比特填充法和违规编码法最实用。

① 字符计数法

比较简单，但也比较容易出问题。

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-10-30-01-11-09-image.png)

用帧首部的一个计数字段（第一个字节），来标明整个帧的字符（字节）数。

容易出问题的原因是一旦这个计数字段在传输时出错了，就无法正确标明帧的长度，也就找不到正确的结束位，导致后面的所有每个帧都会出错。

② 字符（字节）填充法

在帧的首部加上一个字节SOH，尾部加上一个字节EOT，有了这两个，不同的协议SOH和EOT的比特组合不同。

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-10-30-01-10-32-image.png)

仅适用于传输英文文本文件，因为都是ASCI编码，SOH与EOT的比特组合只要取的与ASCI编码不同就不会有冲突；而其他的非ASCI码的语言或文件，只有一个字节的SOH和EOT是很大可能会冲突的。当然解决方法是有的：

在数据部分中与SOH和EOT比特组合一样的地方前面填充一个字节的转义字符ESC，注意ESC前面也要填充ESC：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-10-30-01-08-54-image.png)

在接收端解析时，从SOH知道是帧的开始，遇到ESC把ESC去掉，遇到EOT知道是帧的结束。

③ 零比特填充法

允许帧中包含任意个数的比特。

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-10-30-01-05-21-image.png)

首部和尾部都填充一个字节01111110，作为定界符。

在数据中，每次遇到5个1就在5个1后面填充1个0（五1一0）

接收端只需要每遇到5个1就去掉后面的一个0，就能得到原始数据

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-10-30-01-06-35-image.png)

④ 违规编码法

用数据中不可能出现的编码作为首部和尾部，是在物理层编码时实现的。

如曼彻斯特编码，以前低后高10表示1，前低后高01表示0，那数据是不可能出现11或00编码的，那11和00就是违规的编码，就可以作为首部和尾部。实现非常简单，局域网的IEEE802就是这种方法。

## 3 差错控制

数据在链路上传输，或多或少会受到噪声等影响使得数据出现差错。

噪声可以分为全局性的噪声和局部性的噪声：

* 全局性的噪声：主要是由于链路本身的电气特性产生的随机热噪声，这是信道固有的且随机存在的，解决办法是提高信噪比来减少或避免干扰，提高信噪比可以在传感器那里下手

* 局部性的噪声：由于外界特定的短暂的原因所造成的得到冲击噪声，是产生插座的主要原因。解决办法是利用编码技术解决

差错分两种：

* 位错：比特位发生跳变引发的错误，即1变0，0变1

* 帧错：帧发生错误，有帧丢失、重复帧、帧失序三种，通过帧编号和确认重传机制来做差错控制。由于目前通信链路质量越来越好，由链路质量不好而造成的差错已经很少了，所以现在会针对不同的网络来选择是否蚕蛹确认重传机制

对于链路通信质量好，且有线传输的情况，链路层的协议就不会采用确认重传机制，也不要求给网络层提供可靠传输的服务，若出现了差错，则交给传输层解决。

对于链路通信质量差，且无线传输的情况，链路层的协议就会采用确认重传机制，就会给网络层提供可靠传输的服务。即有确认无连接服务，和有确认面向连接服务

这里的差错控制只解决位错，帧错详见本章可靠传输笔记。

***

无论怎样的差错控制，若无法纠错都会把帧丢弃，所以不能算是可靠传输，即使是海明码遇到2个比特及以上的错误也只能把帧丢弃。因此需要进一步的重传机制才能够实现可靠传输。

### 3.1 检错编码

检错编码主要是奇偶检验编码和循环冗余码，它们赘疣检错能力，没有纠错能力，也就是出错了只能丢弃。

冗余码：为了检错而在源数据中新加入的编码。

（1）奇偶校验码

由1位校验元和n-1位信息元组成，检验元添加在信息元的最前面，信息元即要发送的数据，校验元即冗余码。

* 奇校验码；加入校验元后，整个编码的1个数为奇数，如101变成1101，若接收方发现编码的1的个数为偶数，则说明一定出错了

* 偶检验码：加入校验元后，整个编码的1个数为偶数，如101变成0101，若接收方发现编码的1的个数为偶数，则说明一定出错了

可以看出，及偶检验码的检错能力是有局限性的，若及/偶检验码接收方看到1的个数还是奇数/偶数，就无法判断是否出错了。

可以总结得出，无论是奇校验还是偶检验，都只能检测出奇数个比特的错误，检错能力是50%。

判断一串比特1的个数是奇数还是偶数：每一位依次异或，最终结果0则说明有偶数个1，结果为1则说明有奇数个1，详见计算机组成原理笔记。

（2）循环冗余码

也叫CRC

先看一个例子：

1. 5 /  2 = 2 ... 1     5是源数据，除数2是CRC的生成多项式，余数1是CRC的冗余码（也叫FCS帧检验序列） 

2. 编码后的数据 = 5 + 1 = 6，在链路上传输6，接收端拿到6，6 / 2 = 3 ... 0 ，余数为0，说明没有出现差错

那变成二进制思路也是一样的，只不过是采用模2除法：

若源数据为 1101011011，生成多项式为10011，求FCS/冗余码/帧检验序列，和CRC/循环冗余码：

1. 添0，生成多项式10011也可以写为x^4 + x^1 + x^0，阶数r=4，在源数据后面添4个0得到11010110110000

2. 模2触求出余数FCS，模2除与普通除法发的区别就是在需要减法的地方变成了按位异或：
   
   ![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-10-30-03-23-12-image.png)

3. FCS为1110，CRC为11010110111110

4. 接收端将得到的数据模2除生成多项式10011，若余数为0则说明数据没有出错，若余数不为0，则说明出错了，但也只是直到帧出错了而不知道哪一位比特出错了，所以只能把帧丢弃

求SCS和接收端检错的过程都是硬件实现的，处理非常快。

可以看出，有可能会出现数据出错了但是余数为0的情况，但是概率非常小，在实际中可以认为CRC的检错成功的几率非常接近于1，也就是说只要CRC检侧没错，就可以认为是没有出错的。

### 3.2 纠错编码

主要是使用海明码（也叫汉明码），具有检错能力和纠错能力，纠错能力指它能发现是哪个比特位错了。纠错完还能继续传输。

海明码检错纠错能力也是有限的，只有双比特的检错能力，但只有单比特的纠错能力，也就是说，3个比特及以上的错误检测不出来，2个及以上的比特错误只能检测无法纠错。

例子：源数据101101，求海明码/汉明码。

1. 海明不等式 2^r >= k+r+1 (k为信息位数，r为冗余信息位数)，源数据有6位比特，把k=6代入得r最小是r=4，也就是最终的海明码有6+4=10位

2. 将这4位冗余信息位P1，P2，P3，P4分别插入1源数据不同的位置形成10位还海明码，分别变成10位中的第2^0=1位，第2^1=2位，第2^2=4位，第2^3=8位。然后将6位源数据每一位从左至右（高位到低位）分别编号为D1-D6，按序放到10位中剩余的位置：
   
   ![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-10-30-19-23-17-image.png)

3. 将第一位-第十位的表示变成二进制：
   
   ![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-10-30-19-24-25-image.png)

4. 求每一位检验码，P1对应的的是第一位（0001），0001的1在最低位（第一位），在表中找出最低位是1的数据（P1,D1,D2,D4,D5），这些就是P1能搞校验的位，而检验位P1的值与D1,D2,D4,D5的实际值异或为0：
   
   ![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-10-30-19-33-40-image.png)
   
   P1 异或 D1 异或 D2 异或 D4 异或 D5 = 0  <=>  P1 异或 1 异或 0 异或 1 异或 0 =0
   
   求得：P1 = 0
   
   P2 异或 D1 异或 D3 异或 D4 异或 D6  <=>  P2 异或 1 异或 1 异或 1 异或 1 = 0，P2 = 0
   
   P3 异或 D2 异或 D3 异或 D4  <=> P3 异或 0 异或 1 异或 1 = 0，P3 = 0
   
   P4 异或 D5 异或 D6  <=> P4 异或 0 异或 1 = 0，P4 = 1
   
   ![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-10-30-19-31-48-image.png)

5. 海明码为0010011101

接收端检测和纠错：

上例得到的海明码0010011101，若第5位错误，变成了0010111101，第5位在表中对应D2

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-10-30-19-27-26-image.png)

分别对P1校验的数据，P2校验的数据，P3校验的数据，P4校验的数据进行异或：

P1 异或 D1 异或 D2 异或 D4 异或 D5 = 0 <=> 0 异或 1 异或 1 异或 1 异或 0 = 1

P2 异或 D1 异或 D3 异或 D4 异或 D6 <=> 0 异或 1 异或 1 异或 1 异或 1 = 0

P3 异或 D2 异或 D3 异或 D4 <=> 0 异或 1 异或 1 异或 1 = 1

P4 异或 D5 异或 D6 <=> 0 异或 0 异或 1 = 0

可以看出，第5位对应的D2出错了，那就能够检验它的P1依次异或和P3依次异或的结果为1，且发现P4-P1的结果连在一起是0101，刚好是表明了出错位是第5位。

## 4 可靠传输与流量控制

帧丢失、帧失序、帧重复时接收端都要做一些控制才能保证可靠传输。也就是解决帧错。实现可靠传输的停止-等待协议、GBN协议、SR协议详见传输层笔记。

流量控制是让发送的慢一点，防止接收方来不及接收。

和传输层一样，实现可靠传输和流量控制也是通过滑动窗口。

与传输层的可靠传输和流量控制区别：

* 链路层是点对点（相邻结点之间如网络设备），传输层是端到端（主机与主机之间）

* 链路层的控制手段是接收方收不下就不回复确认，而传输层的控制手段是接收方发给发送方接收窗口打大小

* 链路层滑动窗口大小是固定的，而传输层的大小可以变化的不固定的

* 链路层传输的数据对象是帧，而传输层是分组

***

习题：信道利用率相关的计算（概念见传输层笔记）：

例：数据率4kb/s，单向传输时延30ms，停止-等待协议的信道利用率80%，求帧长度。

帧长度即帧有几个比特，设有L个比特

(L / 4) / (L / 4 + 2 * 0.03 + 0) = 0.8

其中L/4位发送时延，但是题目未给确认帧的发送速率，所以接收时延视为0s，2*0.03位RTT，切得 L/4 = 0.24，即 L = 0.96kb = 960bit

## 5 两种链路

传输链路有两种：

* 点对点链路：两个相邻结点通过一条链路相连，没有第三者，协议有PPP协议，适用于大范围的通信，应用有广域网

* 广播链路：所有主机共享通信介质，一个信号所有主机都能接收到，各主机只会处理目的地址是自己的信息，不是就丢弃。网络拓扑结构是总线型或星型，适用于小范围的通信，应用有总线以太网，无线局域网

### 5.1 点对点链路的协议

有PPP协议和HDLC协议，均用于广域网中，只适用全双工。

PPP协议有同步线路和异步线路：

* 同步线路：以比特为单位传输

* 异步线路；以字节或字符为单位传输

#### 5.1.1 PPP协议

PPP（Point-to-Point Protocol），目前使用最广泛的链路层协议。拨号上网、宽带入网一般使用PPP协议。

PPP协议需要满足的要求：

* 足够简单，只需差错控制即可，无需纠错/序号/确认，即可靠传输、流量控制等交给网络层/传输层实现

* 实现封装成帧

* 实现循环冗余码CRC进行差错检测

* 实现透明传输，同步链路用零比特填充法，异步线路使用字节填充法

* 满足多种网络层协议

* 满足多种链路，如串行/并行/同步/异步/电/光/交换/非交换等等

* 检测连接状态，看链路是否可以正常工作

* 最大传送单元（MTU）不超过1500字节，这里的MTU是网络层传下来的ip数据报，作为帧的数据部分

* 网络地址协商，使通信双方可以通过一些协议确定双方的ip地址

* 数据压缩协商，PPP协议在发送数据时需要压缩数据

* 只需要满足点对点，不需要多点线路

PPP协议的组成部分（即功能）：

* 实现了一个将ip数据报封装到同步/异步串行链路的方法

* 链路控制协议LCP，可以建立并维护数据链路连接，如拨号上网时需要账号密码进行身份验证

* 网络控制协议NCP，通过LCP建立连接后就可以上网，NCP将ip数据报封装给链路层，因为PPP协议支持多种网络层协议，所以每个网络层协议都会对应一个NCP，为网络层协议建立和配置逻辑上的连接

PPP协议工作流程：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-07-11-39-25-image.png)

PPP协议帧格式；

以字节为单位，比特数为8的整数倍，不足则填充0。

第一个/最后一个位为帧定界符7E（01111110），若遇到与7E相同的字节就在前面插入转义字符7D（01111101），遇到7D也在前面插入7D。

A和C目前没有任何作用。

协议标识数据报的类型，如ip数据报、LCP数据报等等。

FCS为循环冗余码的冗余码。

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-07-11-40-13-image.png)

#### 5.1.2 HDLC协议

实际应用比较少，虽然可以实现可靠传输但是没必要，因为现在的链路已经很优秀了很难出现差错，且如果在链路层实现可靠传输会影响网速，所以目前可靠传输都是在传输层实现。

也叫高级数据链路控制协议，是在同步网上传输数据，面向比特的数据链路层协议。

不属于TCP/IP协议组，而是由ISO研发出来的。

与PPP协议的相同点：

* 都只支持全双工

* 都实现了透明传输，但有区别

* 窦世勇CRC

与PPP协议的区别：

|          | PPP          | HDLC      |
| -------- | ------------ | --------- |
| 面向       | 字节           | 比特        |
| 透明传输视线凡是 | 字节填充法/零比特填充法 | 零比特填充法    |
| 可靠否      | 无序号/确认，不可靠   | 有序号/确认，可靠 |
| 帧格式协议字段  | 有            | 无         |
| 帧格式A和c   | 没有作用         | 有作用       |
| 线路       | 同步/异步        | 同步        |

HDLC有三种站：

* 主站：起控制作用的站，功能是发送命令（包括数据信息）帧，接收响应帧，负责对整个链路的控制系统的初启流程的控制、差错检测或恢复等

* 从站：被控制作用的站，功能是接收主站发来的命令帧，向主站发送响应帧，并且配合主站参与差崔恢复等链路

* 复合站：即可以当主站，又可以当从站

HDLC三种操作数据的方式：

* 正常相应方式：从站发送数据需要先经过主站的同意

* 异步响应方式：从站发送数据可以不经过主站的同意

* 异步平衡方式：每个复合站都可以传输数据给别的站，不需要别的站的同意，每个站都是平等的

HDLC帧格式：

使用零比特填充法。

A：正常响应方式和异步响应方式，就填充从站的地址，异步平衡方式填充的是接收站的地址

C：决定HDLC帧的类型，只看前两位

* 0x，是信息帧，用于传输数据信息或捎带确认

* 10，是监督帧，用于差错控制和流量控制，执行对信息帧确认、请求重发、请求暂停发送

* 11，是无编号帧，用于提供链路的建立，拆除等多种控制功能

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-07-11-41-04-image.png)

### 5.2 广播链路的介质访问控制

介质访问控制也叫媒体接入控制或多点接入或MAC。

广播链路中，若多个主机同时发送信号就会发生冲突，介质访问控制就是解决这个问题的，有两种控制手段：

* 静态划分信道：在通信之前先把信道划分好

* 动态分配信道：遇到冲突时再解决

#### 5.2.1 静态划分信道

信道划分介质访问控制。

将使用介质的每个设备与来自同一信道的其他设备信道隔离开，把时域和频域资源合理地分配给网络上的各个设备。

多路复用技术：用复用器把多个信号组合在一条物理信道上传输，使得多个主机共享信道资源，接收时再用分用器把信号分离开，能提高信道利用率。本质就是把一条信道逻辑上划分为多条互不干扰子信道，实现将广播信道转化为点对点信道。

多路复用技术共有频分多路复用（FDM0，时分多路分复用（TDM），波分多路复用（WDM），码分多路复用（CDM）。

（1）FDM

在同一条信道中，按照不同的频段（信道带宽hz）划分多个互不干扰子信道，陪陪给各个用户。用户分配到频段后在通信过程中始终占用该频段。

类比于实际生活中：一个教室划分5个小房间分别给5个班，每天都是同时使用

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-03-19-14-29-image.png)

优缺点：

* 优点：信道利用率非常高，技术成熟实现简单

* 缺点：每个用户分到的带宽就少了

（2）TDM

频段都是一样的，但每个用户并不是每时每刻都占用信道，而是会分时间段占用。

将时间划分为等长的TDM帧或周期（这个帧不是数据链路层的帧，而是物理层比特流划分的帧，标志一个周期，一段时间发送n个比特就是一个周期），每个用户在每个TDM帧中会占用固定序号的时隙，比如图中A占用①时隙，B占用②时隙，它们会轮流使用一个TDM帧的时隙。

类比于实际上火中：一个教室，5个班级，5天一个周期，每个班各独自各占用一天。

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-03-19-13-53-image.png)

但是这样的TDM有个缺陷，就是不管ABCD有没有在使用信道，它们都会均分地占用一个时隙，导致信道资源的浪费，信道利用率低。

优化方案是使用STDM（统计时分复用），有一个集中器，将ABCD连接起来并收集它们的数据，再通过高速线路发送到主机，效果是当ABCD谁需要使用信道时，再动态地分配到STDM帧得到时隙，STDM帧的时隙数是小于集中器连接的用户数的。

STDM大大提高了信道利用率。

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-03-19-13-19-image.png)

优缺点：

* 优点：信道利用率高，且每个用户使用时都恩能够使用全部带宽（但只是在使用时占用全部带宽，与缺点一结合总体上还是被均分了，STDM可以优化）

* 缺点：每个用户只能在自己的时隙才能使用，STDM可以优化

***

习题：ABCD四个用户，信道最大速率8kb/s，TDM的话每个用户速率多少？STDM中若只有A使用信道，只有AB使用信道，速率多少？

解：TDM，不管ABCD有没有在使用信道，速率都是 8 / 4 = 2kb/s

STDM只有A使用，速率为8kb/s，只有AB使用，那AB速率都是 8 / 2 = 4kb/s

（3）WDM

本质是光波的FDM，在一条光纤中传输不同的波长，每个波长作为一个子信道。

波长 = 1 / 频率

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-03-19-11-53-image.png)

（4）CDM

结合了FDM和TDM的优点。在同一时间都可以用，且按需占用带宽。

类比于实际生活中：一个教室，5个班级，不用分房间不用分时间，都在一起使用教室，通过不同的国家语言接收自己的信息。

CDM有很强的抗干扰性，因为它的频谱很像白噪声，不易被窃听。

实现方式：

这里只介绍码分复用的一种方式：码分多址（CDMA）。

CDM是将一个比特分为多个码片或芯片，每个站点被指定一个惟一的m位的码片序列。m通通常是64或128，但为了研究方便也可以是8位等等。

使用CDM后，发一个比特变成发送m个比特，为了保证速狙率不降低，法苏速率必须变为原来的m倍。

码片序列：

* 码片序列中的每一位，+1代表1，-1代表0

* 若整个码片序列代表1，那0就是该码片序列的反码

```
某码片序列如101101：
代表1：+1 -1 +1 +1 -1 +1
代表0：-1 +1 -1 -1 +1 -1
```

规格化内积 ：两个码片序列每一位相乘身乘，得到的结果再求和，最后除以位数：

```
[+1,+1,-1]
[-1,+1,+1]
正交的结果为：(1*(-1) + 1*1 + (-1)*1) / 3 = -1/3
```

正交：规格化内积为0，正交其实就是两个向量垂直。

每个站点的麻片序列需要满足的条件：

* 每个码片序列必须唯一，且位数相同

* 两两之间的规格化内积结果均为0，即每个码片序列与其他码片序列都是相互正交，垂直的。即可以得出使用m位码片序列，则能供m个站点使用

每个麻片序列的性质：

* 自己与自己规格化内积结果为1

* 自己与自己的反码规格化内积结果为-1

例：某广播链路有AB两个站点，A麻片序列为[+1,+1,-1,+1]，B码片序列为[-1,-1,-1,+1]，则：

* A发送比特1实际上发送的是 1101，A发送比特0实际上发送的是 0010
  
  B发送比特1实际上发送的是 0001，B发送比特0实际上发送的是 1110

* 若AB同时发送比特1，则实际上发送的码片序列进行线性相加的结果（每一位相加）：
  
  ```
    [+1,+1,-1,+1]
  + [-1,-1,-1,+1]
  = [0,0,-2,+2]
  ```
  
   若发送比特0则计算比特0的麻片序列，若没有发送则不参与计算

* 接收端收到后，将得到的数据依次与各站点的比特1码片序列计算规格化内积，若：
  
  * 结果为1，则该站点发送了比特1
  
  * 结果为0，则该站点没有发送数据
  
  * 结果为-1，则该站点发送了比特0
  
  如收到 [0,0,-2,+2]，则：
  
  ```
  A: [0,0,-2,+2] 与 [+1,+1,-1,+1] 正交结果为 1
  B: [0,0,-2,+2] 与 [-1,-1,-1,+1] 正交结果为 1 
  活命AB都发送了比特1
  ```

***

习题：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-03-19-05-21-image.png)

解：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-03-19-06-02-image.png)

习题：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-04-09-33-07-image.png)

解：B，收到的是12位，而A的码片序列是4位，那就将12位每4位分为一部分，每个部分与A的码片序列求滚个华内积，结果为 1 -1 1，即A发送了101

#### 5.2.2 动态分配信道

分为轮循访问介质访问控制、随机访问介质访问控制。

##### 5.2.2.1 随机访问介质访问控制

所有的用户都可以随机地发送信息，随机指的是先发送就发送，且发送时占用全部带宽。

冲突：两个及以上的站点同时发送帧就会发生冲突，需要返回一个确认帧让原站点直到发生了冲突。

（1）ALOHA协议

纯ALOHA协议：

思想：不监听信道，不按时间槽发送，随机重发。

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-04-09-30-17-image.png)

若：

* 无冲突，发送成功，返回一个确认

* 有冲突，接收方可以通过差错控制检测出来，不返回确认，而发送方瑞若没收到确认，会通过超时重传的机制来处理冲突，超时了就说明有冲突需要重传。重传也需要等待一个随机时间后才能重传；是否重传也有概率P的机制，了解就行不用知道细节

（2）时隙ALOHA协议

改进的纯ALOHA协议，纯ALOHA协议发送帧的成功率很低（吞吐量低），效率低。

思想：把时间分为若干相同的时间片，所有用户在开始时同步接入网络信道，只有在时间片开始才能发送帧，若发生冲突，就必须等到下一个时间片开始再发送。

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-04-09-30-55-image.png)

（3）CSMA协议

全称为载波监听多路访问协议。用于早期的共享式以太网（总线型）

思想：在发送帧之前先监听信道，空闲了再发送帧。

多址接入：

多个主机/站点连接在总线上

载波监听：

每个站发送帧之前，先检查总线上是否有其他站点在发送帧，若检测到空闲96比特时间，就可以发送；若检测到忙，则继续检测

* 检测是否空闲的原理：检测电压的摆动值，若几个站点同时发送帧，总线的电压值会增大，若超过本站一个门限值说明有站点在发送帧

* 96比特时间指的是发送96比特需要的时间，也叫帧间最小间隔，作用是使接收方可以检测出帧的结束，同时使其他站点能平等竞争信道并发送帧

常规的CSMA协议可以细分为3个类别：

坚持指的是监听信道空闲或忙之后的坚持行为

* 1坚持CSMA：监听信道空闲后立即发送帧，监听信道忙后，会一直监听信道，直到空闲为止，并立即发送帧，若发生冲突则会等待一个随机的时间后，再去监听信道
  
  优点：空闲就会立即发送帧，媒体利用率高（信道的利用程度高）
  
  缺点：冲突很难避免

* 非坚持CSMA：监听信道空闲后立即发送帧，监听信道忙后，等待一个随机时间后再去监听信道
  
  优点：每个站点采用随机的重发时间，减少了冲突的产生
  
  缺点：可能会存在所有站点都在等待的情况，导致信道完全空闲，舒蝶媒体利用率低

* P坚持CSMA：监听信道空闲后，不一定会发送帧，而是概率P会进行传输且不必等待，或者概率1-P就等一个时间槽开始后后再传输；若信道忙，则等待一个随机时间后再去监听信道
  
  优点：结合了1坚持和非坚持的优点
  
  缺点：发生冲突后，还会据需把冲突的帧发送完，这是不必要的浪费

（4）CSMA/CD协议

只适用于半双工通信，总线式以太网。

全称是载波监听多点接入/碰撞检测协议，在CSMA协议的基础上增加了碰撞检测，冲突就会碰撞，检测到碰撞就可以停止继续发送冲突的帧，而不用把冲突的帧发送完。

有了载波监听，还会产生冲突的原因：

载波监听时监听附近是否有信号，即使电磁波速度很快，当随着链路的长度增长，信号到达该站点的延迟就会增大，就会发生A发送了帧，但是链路比较长需要一定时间到达B，而B在信号没到达前检测到信道为空闲，就会发送帧。

碰撞检测：

每个站点发送帧后，会边发送帧边检测碰撞，一旦发生碰撞就立即停止发送，退避一段随机时间后再发送之前发送的帧。检测碰撞也是通过检测电压的摆动值。

tao得概念：

以T暂时表示希腊字母tao

读作tao第一声，表示单程端到端船舶时延，即电磁波在信道上的单方向的传播时延。

以太网还会采取强化碰撞的措施，在停止发送的基础上，会发送32比特或48比特的人为干扰信号，使得有更多的碰撞信号提前让其他站点检测出碰撞。

检测到碰撞需要的时间：

如图，x轴为距离，y轴为时间

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-04-09-36-20-image.png)

设德塔为8

设A发送帧，过了 T - 8 时间后，D开始发送帧，可以得出经过 T - 1/2 8 时间后发生碰撞

A发送的帧经过 8 时间到了D后，D通过差错控制知道了有碰撞

D发送的帧经过 2T - 8 时间到了A后，A通过差错控制知道了有碰撞

即A、D两者最迟检测到碰撞的时间是 2T - 8，又 0 <= 8 <= 2T，得出：

* 8趋近于0时，A发送的帧趋近于到了D，D才发送帧，此时B能立刻检测到碰撞；但是此时A需要 2T 时间采恩能够检测到碰撞，也就是说，A、D两者最晚检测到碰撞的时间是 2T

* 8趋近于2T时，D发送的帧趋近于到了A，A才发送帧，此时A能立刻检测到碰撞；但是此时D需要 2T 时间采恩能够检测到碰撞，也就是说，A、D两者最晚检测到碰撞的时间是 2T

只要经过了 2T 时间后，A、D都没有收到碰撞的确认帧，则说明一定没有发生碰撞，2T也叫争用期或碰撞窗口。

重传：

当检测到碰撞后，需要立即停止帧的发送，因为急需发送错误的帧已经没有意义了还浪费资源。停止后，需要等待一段时间才能重传，不能立即重传如AB两个站点同时发送帧，那它们会在0.5T后碰撞，都会在T后检测到碰撞，如果立即重传，就会进入死循环。

CSMA/CD的重传时间通过截断二进制指数规避算法求出：

1. 确定一个基本退避时间，是争用期2T

2. 定义一个参数k，k为重传次数，当 k >= 10 时恒定为10

3. 从离散的整数集合 {0,1,3...,2^k-1} 中，随机取出一个数r

4. 重传时间 = r * 2T

5. 当重传次数达到16时，若依旧有碰撞，则说明网络很拥挤，就抛弃此帧不传了，并报告给上层出错了

该算法可以使重传需要推迟的平均时间，随着碰撞次数增大而增大，进而减小碰撞的概率，有利于系统的稳定。

最小帧长：

若发送的帧很小，发生了碰撞，经过一段时间后检测到碰撞，在这段时间内这个很小的帧就可能会发送完，就达不到CSMA/CD协议让碰撞的帧停止发送的效果。

因此就有了最小帧长的概念，最小帧长(bit) >= 2T * 数据传输速率（发送速率） 

以太网规定的最小帧长是64B，方式小于64B的字节都认为是由于冲突而异常终止的无效帧，所以以太网会对于小于64B填充0到64B

***

习题：以太网采用二进制回退算法，11次碰撞后，会从0-?中取出随机数r？

解：0,1,3,7,15,31,63,127,255,511,1023

（5）CSMA/CA协议

用于无线局域网。

全称是载波监听多点接入/碰撞避免协议，在CSMA协议的基础上增加了碰撞避免。

CDMA/CD只能检测碰撞不能避免碰撞，CDMA/CA只能避免碰撞不能检测碰撞。相同点是都有CSMA的通性，发送帧前都需要载波监听；不同点是传输介质不同，解决冲突的方式不同，和载波监听方式不同，CDMA/CA的载波监听需要结合能量检测，载波检测，能量载波混合检测。

之所以无线局域网无法使用CDMA/CD协议，是因为无线局域网中检测碰撞是很困难的，要渐层的方向是360度，非常难以实现，且还有隐蔽站的原因。

隐蔽站：

A、B可以发送帧给C，若AB同时发送给C就会发生冲突。A发送给C，B相对于A就是一个隐蔽站，隐蔽就是B不知道A要发送帧，所以B就会不管不顾地发送帧给C，导致冲突。

CSMA/CA的工作原理：

冲突避免的三个机制：预约信道，ACK确认帧，RTS帧和CTS帧（可选）

* 每次发送帧前，都会检测信道是否空闲，这是CSMA的通性
  
  * 若空闲：可发可不发送一个RTS（request to send）给接收方，发送了可以解决隐蔽站的问题，接收方收到RTS会返回一个CTS（clear to send），相当于建立了一个连接，若有替他的站点发送帧给接收方，接收方就不会处理
  
  * 若忙：等待一段时间

* 发送方收到CTS后，就可以开始发送帧，并预约信道，预约信道指告诉其他站点自己需要传输多久。预约信道即可以让其他站嗲你知道需要等待多久时间，也可以让其他站点在这段时间不发送帧，达到冲突避免的效果

* 因为需要RTS和CTS建立连接，所以哦发送帧前，都会等一段时间

* 接收方收到帧后，进行差错控制，若无差错则返回ACK给发送方，发送方只有收到了ACK才会发送下一个帧；若没有收到ACK则需要重传，但不能立即重传，重传时间和CDMA/CD协议一样采用截断二进制指数规避算法，重传的次数一样也是有限制的

##### 5.2.2.2 轮徐访问介质访问控制

静态划分信道在网络负载比较重时共享信道公平且效率高，但是在网路负载轻时，效率就比较低了，因为信道划分好了但是被闲置了。

随机访问介质访问控制在网络负载比较重时非常容易发生冲突导致需要大量的重传，效率低；而网络负载轻时，冲突少，且独占信道，效率高。

轮循访问介质访问控制使用轮循访问MAC协议，也叫轮流协议或轮转访问MAC协议，结合了静态划分信道和随机访问介质访问控制的优点，可以即不产生冲突，又可以在发送时占用全部带宽。

分为几个部分，最主要的两部分是：轮循协议和令牌传递协议

（1）轮循协议

主节点会轮流询问其他节点发送数据，一个节点发送数据时其他节点无法发送数据。主节点询问其他节点是发送一个比较短的数据帧。

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-07-11-43-54-image.png)

缺点：

* 具有轮循开销

* 靠后的主机有等待延迟

* 单点故障：若主节点宕机则其他节点都无法发送数据，解决方法是多几个备用主节点

（2）令牌传递协议

用于令牌环网。

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-07-11-42-53-image.png)

令牌环网：物理上是环形结构，但逻辑上是星型结构。

* TCU转发器：作用是转发经过的帧并为接入的站点发送/接收数据提供接口

* 令牌：特殊格式的MAC控制帧，不包含信息，只用几个比特构成，作用是控制信道的使用，确保同一时刻只有一个节点独占信道

令牌协议工作流程：

* 信道空闲时，令牌在各个主机之间传递，直到传递到的主机需要发送帧为止，该主机持有令牌

* 主机持有令牌后，需要修改令牌的标志位，使令牌从空闲状态变为忙的状态

* 发送帧时，将数据帧放到令牌后面一起传输，传递到非接收方时，非接收方不作处理。传输到接收方时，接收方复制一份，并让令牌和数据帧传回发送方

* 经过一轮，发送方收到自己发送的帧，进行差错控制，若出错则需要重传，若没有出错则回收数据帧并不再转发该数据帧，令牌修改标志位变为空闲状态，令牌空闲后重复上述操作

个主机持有令牌的时间是有限的，若发送的数据太长，发送时间超过了令牌持有时间且其他主机也需要发送帧，则令牌让给其他主机。没发完的数据则会分段，下次持有令牌时再发送

令牌的机制适用于网络负载较大的网络，网络负载轻的网络令牌也会一直转，浪费性能。

令牌协议的缺点：

* 令牌开销：令牌丢了需要重新创建，主机发送完数据也可能会创建一个新令牌

* 等待延迟

* 单点故障：若某个主机宕机了，那整个链路都断了，解决方法是每个主机都多几个备用机

## 6 数据链路层的设备

集线器连接的每条链路最长不超过100米，否则失真就非常严重，无法恢复，扩展范围的方法有：

* 传输介质使用光纤，因为光纤受到的干扰少，可以有更长的距离

* 通过主干集线器连接多个集线器

每个集线器连接的主机构成一个冲突域，冲突域就是只能有一个主机发送数据否则就会产生冲突，不在同一个冲突域的主机不会产生冲突。

主干集线器虽然扩充了通信范围以及实现不同冲突域的主机通信，但是也罢各个冲突域连接起来了，使得不同冲突域的主机之间也只能有一个主机发送数据否则会产生冲突。若主干集线器连接了三个冲突域，每个冲突域的吞吐量均为10Mb/s，那总的吞吐量也只有10Mb/s。

数据链路层的设备有网桥和交换机，就解决了这个问题。

冲突域和广播域：

冲突域内同时只能有一个主机发送数据，否则会产生冲突，会产生冲突的集合就构成冲突域，不同冲突域不会产生冲突

广播域是网络中能接收任意设备发出的广播帧所有设备构成的集合，不同广播域不会互相广播。

物理层设备、数据链路层设备、网络层设备对冲突域和广播域隔离的程度：

| 设备      | 是否隔离冲突域 | 是否隔离广播域 |
| ------- | ------- | ------- |
| 集线器、中继器 | 否       | 否       |
| 网桥、交换机  | 是       | 否       |
| 路由器     | 是       | 是       |

### 6.1 网桥

网桥可以根据MAC帧的目的地址，对帧进行转发和过滤。

当网桥收到MAC帧后不会转发到每个接口，而是会检查目的地址，来决定转发到对应的接口，若无法转发就丢弃（过滤）。

网桥的端口比较少，一般有2个，也有3个4个的，每个端口连接一个以太网，每个被连接的以太网都自己构成一个冲突域（也叫网段）：

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-09-16-15-40-image.png)

网桥的优点：

* 过滤通信量，增大吞吐量，因为网桥可以分隔开各个冲突域，不同冲突域是不会有干扰的不会冲突的，且不同冲突域的主机也可以通信，若两个网桥连接了三个冲突域，每个冲突域的吞吐量均为10Mb/s，那总的吞吐量就是30Mb/s

* 扩大了通信范围

* 提高了可靠性，当某个网段内故障，通常只有该网段受影响，其他网段不受影响

* 可以互联不同物理层、不同MAC子层、不同速率的以太网

网桥分类：

* 透明网桥：透明指以太网上的站点不知道发送的帧要经过那几个网桥，是即插即用的，具体要经过那几个网桥是通过自学习的算法。
  
  自学习算法：每个网桥维护一个交换表，内容为地址和接口两列，初始时所有网桥的交换表都是空的，自学习就是在通信过程中逐步完善转发表，如下图为例：
  
  ![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-11-09-16-14-47-image.png)
  
  1. A发送数据给B：A发送的数据在此网段中广播，B和网桥M的1接口会收到。B收到发现是自己的就接收，1接口查询交换表发现，发送端没有A的记录，就填入地址为A的MAC地址，接口为接口1的记录；接收端没有B的记录，就转发到接口2转发出去，CD发现不是给自己的就丢弃。网桥N现找发送端A和接收端B的记录继续自学习，到了EF发现也不是自己的就丢弃
  
  2. F发送数据给C，类似于上面
  
  3. B发送数据给A，先广播，A和网桥M的1接口收到，A收到发现是自己的就接收，接口1查询转发表，发现没有发送端B的记录，就记录下来；查找发现有接收A的记录，就知道要转发到哪里，所以不需要再转发给别的网段了
  
  转发表是会不断变化的，更新频率比较快，每次更新都会清空转发表，再次自学习，以应对最新的网络拓扑状态

* 源路由网桥：发送帧的时候，把详细的最佳路由信息（经过的路由器最少或通信时间最短都行）放在帧的首部。
  
  方法：源站以广播方式向欲通信的目的站发送一些发现帧，发现帧到了目的站后，目的站会返回相应帧（会者也能说发现帧原路返回），源栈就能根据这些相应帧找出最佳路由信息

### 6.2 交换机

也叫以太网交换机，或多端口/多接口的网桥，目前交换机基本取代了网桥。

交换机通常有十几个端口，每个端口都可以连接集线器或主机。

交换机原理基本和网桥差不多，但交换机每个端口以独占传输媒体总带宽

交换机的两种交换方式可以妇女为三种交换机：

* 直通式交换机：只检查帧的目的地址，检查之后就立刻转发
  
  优点：时延少
  
  缺点：可靠性差，因为不会检查帧的错误；无法支持不同速率端口的交换

* 存储转发式交换机：将帧放入告诉缓存并检查帧是否正确，若正确就转发，错误就丢弃，实际生活中用的一般是这种交换机
  
  优点：可靠性好一些，因为会检查帧的错误；支持不同速率端口的交换
  
  缺点：时延较多

* 两种交换方式混合的交换机

# 六、物理层

## 1 基本概念

物理层是解决如何在连接各种计算机的传输媒体上传输数据比特流，而不是指具体的传输媒体（光纤，同轴电缆，双绞线，无线等）。物理层不关心传输媒体的具体细节，只管本层次的内容、设备和下层的传输媒体的接口。所以传输媒体也可以叫第0层。

物理层特性：

- 机械特性：定义物理连接的特性，规定物理连接所采用的规格、接口形状‘引线数目、引脚数量和排列情况等

- 电气特性：规定传输二进制位时，线路上信号的电压范围、阻抗匹配、传输速率和距离限制等

- 功能特性：指明某条线上出现的某个电平表示何种意义，接口部件信号线的用途，注意电气特性的电压范围指的是某范围内表示高还是低电平，而功能特性则是指高低电平表示什么意义

- 规程特性（也叫过程特性）：各条物理线路的工作规程和时序关系

## 2 通信基础之概念

电话、电报、网络等等都算是数据通信的范畴。

网络有两种入网方式：

* 电话线入网，早期的入网方式，电话线上传输的是模拟信号，而计算机发送/接收的是数字信号，所以在发送和接收时需要调制解调器进行数模转换

* 宽带网络入网，网络上传输的是数字信号

数据通信基本概念：

* 通信：母的是为了传输信息

* 数据：是传递信息的实体，通常是有意义的符号序号，如比特流

* 信号：数据的电气电磁的表现，是数据在传输过程中的存在形式，分为数字信号和模拟信号。
  
  数字信号：参数取值是离散的。
  
  模拟信号：参数取值是连续的。

* 信源：发送数据的源头

* 信宿：接收数据的终点

* 信道：传输信号的媒介，表示一个方向的传输恓的介质，因此信道包括往返方向信道，信号只有在信道上才能传输。
  
  根据传输的信号类型可以分为：数字信道，模拟信道。
  
  根据传输介质可以分为：有线信道，无线信道。

通信方式：

* 单工通信：只有一个方向的通信，没有反方向的交互，因此只有一条方向的信道，即只发不收。常见的有广播。

* 半双共通信：通信双方都可以发送和接收，但是不能同时发送和接收，具有两条信道。常见的有对讲机。

* 全双工通信：通信双方都可以发送和接收，并且可以同时发送和接收，具有两条信道。常见的有手机。

数据传输方式：

* 串行传输：一个个比特排队传输，适合远距离的传输因为费用低
  
  优点：只需要往返两条信道、费用低。
  
  缺点：速度慢

* 并行传输：可以同时发送多个比特进行传输，适合于近距离传输因为费用高
  
  优点：速度快
  
  缺点：需要很多条信道，费用高

## 3 通信基础之码元

（1）码元：

数据需要变为数字信号才能在信道中传输。

码元是用一个固定时长的信号波形（也叫数字脉冲），来代表不同离散数值的一个基本波形。它是数字通信中数字信号的计量单位，这个时长内的信号称为k进制码元，该时长称为码元宽度。

二进制码元：1个码元1个比特，有0和1两种状态

四进制码元：1个码元2个比特，有00/01/10/11四种状态

k进制码元以此类推

（2）速率：

也叫数据率，指数据的传输速率，表示单位时间内发送到信道上的数据量，可以用码元传输速率和信息传输速率表示。注意这个是发送速率而不是传播速率。

* 码元传输速率（码元速率/波形速率/调制速率/符号速率）：单位时间内数字通信系统内传输的码元个数（脉冲个数/信号变化次数），单位波特（Baud），1波特表示数字通信系统每秒传输一个码元，码元速率与码元进制数无关。
  
  相同的码元速率，传输的比特数可能不同，因为一个码元的比特数可能不同

* 信息传输速率（信息速率/比特率）：单位时间内数字通信系统传输二进制码元个数或比特数，n bit的码元，码元速率为m Baud，那信息传输速率为 吗 * n bit/s

（3）带宽

表示单位时间内从网络的某一点到另一点所能通过的最高数据率，常用来表示网络的通信新线路传输数据的能力，单位 bit/s，是通信线路支持的最高速率。

（4）习题

四进制码元4s内传输了8000个码元，则：

* 四进制码元，一个码元2个比特，4中状态00、01、10、11

* 码元传输速率 = 8000 / 4 = 2000(Baud)

* 信息传输速率 = 2 * 2000 = 2 * 8000 / 4 = 4000(bit/s)

## 4 通信基础之数据编码和信号调制

（1）基本概念

信号在信道传输的两种形式：

* 基带信号：将数字信号的0和1用两种不同的电压表示，再送到信道上进行基带传输，来自信源的信号就是基带信号，因此基带信号可以是数字信号和模拟信号，但是在计算机网络中基带信号因为计算机发出的都是0和1，所以只能是数字信号，所以计算机网络中的基带信道都是数字信道

* 宽带信号：将基带信号载波调制后把信号的频率范围移到较高的频段，形成的频分复用的模拟信号，在模拟信道上传输，仅在一段频率范围内能够通过信道。高频的信号可以应对信号衰减很大的环境，即使衰减了，接收端也可以过滤出来

距离短时使用基带信号传输，因为距离短信号衰减小

距离远使用宽带信号传输

（2）编码

计算机发出的0和1就是数字数据，声音等就是模拟数据，不管是什么数据需要变成信号才能在信道传输，编码就是：

* 使用数字发送器将数字数据编码成数字信号

* 使用PCM编码器将模拟数据编码成数字信号

数字数据编码成数字信号：

用于基带传输，基本不改变数字信号的频率

| 编码方式     | 说明                                                                                                                  |
| -------- | ------------------------------------------------------------------------------------------------------------------- |
| 非归零编码    | 高1低0（不推荐使用），优点是容易实现，缺点是没有检错功能且无法判断码元的开始和结束，导致收发双方难以保持同步，如无法判断连续的1和连续的0到底有多少个1和0，所以需要发送方另外建立一条信道发送给接收方时钟周期来算出多少个1和0, |
| 曼彻斯特编码   | 前高后低为1，前低后高位0（一般规定是这样，也有可能是反过来，得看规定），每次都有跳变相当于同时传输了时钟周期（自同步）。由于一个码元分割为前后两个相等的间隔，因此二进制码元信息传输速率是码元速率的一半               |
| 差分盲测斯特编码 | 左边虚线左右相同为1，左边虚线左右不同为0，常用于局域网，特性和曼彻斯特编码一样，但是差分的抗干扰性更强                                                                |
| 归零编码     | 归零为1，0处不变为0（不推荐使用），由于很长时间会处于0，接收方也很难判断连续的0有几个0                                                                      |
| 反向不归零编码  | 不跳变为1，跳变为0（不推荐使用），如果是连续的0会一直跳变，接收方很好判断；如果是连续的1则一直不变，接收方判断不出有几个1                                                     |
| 4B/5B编码  | 每4个比特都插入一个比特变成5个比特的编码，具体如何编码比较复杂不需要了解。编码效率为80%                                                                      |

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-10-26-15-33-05-image.png)

<img title="" src="file:///C:/Users/Administrator/AppData/Roaming/marktext/images/2022-10-26-15-35-47-image.png" alt="" width="641">

模拟数据编码成数字信号：

使用PCM编码，编码过程为抽样，量化，编码。

| PCM编码步骤 | 说明                                                                                                |
| ------- | ------------------------------------------------------------------------------------------------- |
| 抽样      | 对模拟信号进行周期性的扫描，把事件上连续的信号变为时间上离散的信号。为了使得将这些离散信号无失真的代表被抽样的模拟数据，要使用采样定理进行采样 （采样定理：采样频率 >= 2 * 信号最高频率） |
| 量化      | 把抽样取得的电平幅值按照一定的分级标准转化为对应的数字值并取整，这样就把连续的电平幅值转化为了离散的数字值                                             |
| 编码      | 将量化的结果转化为对应的二进制编码                                                                                 |

（3）调制

计算机发出的0和1就是数字数据，声音等就是模拟数据，不管是什么数据需要变成信号才能在信道传输，调制就是：

* 使用调制器将数字数据调制成模拟信号

* 使用放大调制器将模拟数据调制成模拟信号

数字数据调制成模拟信号：

| 调制方式 | 说明                                                                        |
| ---- | ------------------------------------------------------------------------- |
| ASK  | 调幅，1有振幅，0没有振幅                                                             |
| FSK  | 调频，1频率高，0频率低                                                              |
| PSK  | 调相，1和0各自对应正弦波或余弦波                                                         |
| QAM  | 正交振幅调制，调幅和调相的结合，可以是调幅后再细分几个相位，也可以是调相后细分几个幅度。幅度数 * 相位数 = 状态树 = 2^k (k进制码元) |

![](C:\Users\Administrator\AppData\Roaming\marktext\images\2022-10-26-15-40-30-image.png)

模拟数据调制成模拟信号：

为了实现传输的有效性，需要较高的频率，这种调制方式还可以使用频分复用技术，充分利用带宽资源。在电话机和本地交换机所传输的信号是采用模拟信号传输模拟数据的方式，模拟的声音数据是加载到模拟的在波奇中传输的。

## 5 通信基础之奈氏准则和香农定理

（1）基本概念

噪声与信噪比：

噪声存在于所有的电子设备和通信信道中。由于噪声随机产生，它的瞬时值有时会很大，因此噪声会使接收端对码元的判决产生错误，但是噪声的影响是相对的，若信号较强，那相对的噪声的影响就变小了，因此引出了信噪比的概念，来衡量噪声对信道的影响程度。

信噪比 = 信号的平均功率 / 噪声的平均功率，单位S/N或不带单位，但是S/N的数值有时候可能很大，为了直观，有时会使用分贝（db）为单位，db = 10log(10)(S/N)

db和S/N都是信噪比，。只是表示形式不同。

失真：

信号在传输的时候比起原始传的信号发生了扭曲和变化。

造成失真的原因：

* 码元传输速率，信号失真的程度就越严重

* 信息传输距离越长，信号衰减就越久，干扰越久

* 噪声干扰越多越容易失真

* 传输介质质量越差，失真越严重

信道频宽：

也叫信道带宽，注意这个带宽和之前笔记的带宽概念不同（之前笔记的是信号带宽，指信道支持的最高速率），这里的带宽指的是信号的最高频率和最低频率之差，单位为hz。

信号频率越快，表明码元变化的越快，即码元速率越快

* 过低的信号频率，非常容易衰减，接收端收不到信号

* 过高的信号频率，会造成码间串扰，接收端区分不出波形的差异，失去了码元之间清晰的界限

（2）奈氏准则（也叫奈奎斯特定理）：

在理想低通，条件下，为了避免码间串扰，极限码元传输速率为2W Baud，W为信道带宽（hz）。理想指无噪声无干扰，低通指信道带宽受限，低于最高频率的频率可以通过的意思。

即奈氏准则求的是最高码元传输速率。

推论：

* 根据最高码元传输速率，配合给出的状态数V（状态数可以求出k进制码元，k = logV），就能得出最高信息传输速率（最高数据传输率） = 2W * logV (biy/s)

* 信道带宽越大，码元速率越快，因为带宽越大，频率范围越大，可以传输更高频率（更高码元速率）的信号

* 只限制了码元速率，没有限制信息传输速率，为了提高信息传输速率，需要提高每个码元携带的信息量，即k进制码元k变大

习题：信道信道3000hz，4个相位，每个相位4种振幅，求最大数据率：

最大数据率 = 2 * 3000 * log(4*4) = 24000bit/s = 24kb/s

无噪声，

（3）香农定理：

在带宽受限，有噪声的信道中，为了不产生误差，信息传输速率有一个上限值：

最高信息传输速率 =  W * log(1+S/N)，单位为bit/s ，W为信道带宽，S/N为信噪比

即香农定理求的是最高信息传输速率。

推论：

* 只要信息传输速率小于最高信息传输速率就符合香农定理，一定有方法实现无差错的传输

* 信道带宽越大，最高信息传输速率越大

* 信道带宽和信噪比确定了，最高信息传输速率就确定了

习题：

信道带宽3000hz，信噪比30db，求最大数据传输率：

S/N = 10 ^ (30/10) = 1000

最大数据集传输率 ≈ 3000 * log(1+1000) ≈ 30000(bit/s) = 30kb/s

（4）两个公式哦如何选用

如果题目出现了带宽和信噪比/状态数来就最高信息传输速率，用香农定理/奈氏准则，如果信噪比和状态数都给了，就两个公式都求一下，为了稳定取两者的较小值。如：

二进制信号，信噪比127，4kHZ信道，求最高数据率

奈氏准则结果 = 2 * 4000 * 1 = 8000bit/s = 8kb/S

香农定理结果 = 4000 * log(1+127) = 28000bit/s = 28kb/s

所以最高数据率为8kb/s

## 6 传输介质

传输介质也叫传输媒体/传输媒介，即数字传输系统中发送设备和接收设备之间的一条实际存在的物理通路（信道是抽象出来的逻辑通路）。

需要注意的是，传输介质不是物理层的内容，而是物理层下一层（第0层）的内容，传输介质中传输的信号但是传输介质本身不知道传输的信号代表的意思，纯粹只作为传输的线路；而物理层规定了电气特性，所以知道传输的是比特流。

传输介质分类：

* 导向性的传输介质（也叫导引）：电磁波被导向沿着传输介质进行传输，介质可以是铜线、光纤等。
  
  1. 双绞线：最古老，最常用，价格便宜的传输介质，局域网/电话网普遍使用，数字传输/模拟传输都可使用，通信距离寄几公里到几十公里。双绞线由两根采用一定规则并排绞合、相互绝缘铜导线组成。两条线电流相反，绞合在一起是为了抵消两条导线的电磁干扰。带水晶头的绿色网线就是非屏蔽就是由4组双绞线组合而成的
     
     | 双绞线类型       | 结构                                                     |
     | ----------- | ------------------------------------------------------ |
     | 无屏蔽双绞线（UTP） | 从内到外方分别是两根铜导线、绝缘层和聚氯乙烯（塑料）套层                           |
     | 屏蔽双绞线（STP）  | 从内到外方分别是两根铜导线、绝缘层、金属丝编织的屏蔽层和聚氯乙烯（塑料）套层。屏蔽层可以进一步减少电磁干扰。 |
  
  2. 同轴电缆，由导体铜质芯线、绝缘层、网状编织屏蔽层和塑料外层组成。导体就是铜线，可以是单条也可以使多条绞合而成。抗干扰新比双绞线更强，传输速率更大，传输距离更远，但是价格更贵
     
     | 同轴电缆分类 | 说明               |
     | ------ | ---------------- |
     | 基带同轴电缆 | 传输基带信号，主要用于局域网等  |
     | 宽带同轴电缆 | 传输宽带信号，主要用于有线电视等 |
  
  3. 光纤（光导纤维），传输的是光脉冲/光波（双绞线和同轴电缆传输的是电脉冲/电磁波）。带宽非常大噶，通信量很大，所以频率可以很高，速度会很快，且体积小重量轻。需要在发送端/接收端进行光电转换将电脉冲转化为光脉冲，发送端使用光源来转换（可以是发光二极管，或半导体激光器），接收端使用光电二极管做成的光感应器还原为电脉冲。
     
     光纤由实心的纤芯和包层组成，光波通过纤芯传导，纤芯的折射率很高，包层的折射率低一些，当光波从高折射率的介质射入到低折射率的介质，折射角会大于入射角，而入射角足够大就会发生全反射，即光线碰到包层就反射，损耗很小。因此光纤可以应用于长距离传输。
     
     光纤抗雷电和抗电磁干扰新强，保密性也强
     
     | 光纤分类 | 说明                                                           |
     | ---- | ------------------------------------------------------------ |
     | 多模光纤 | 传输多条光波，通过全反射传输，光源是发光二极管，虽然全反射损耗很很小，但随着距离越长，损耗也可能大到无法接受       |
     | 单模光纤 | 光纤的直径小到只有一条光波能通过，光源是定向性很好的激光二极管，光不是全反射而是直射，损耗几乎没有，适合非常长的距离传输 |

* 非导向性的传输介质（也叫非导引）：在自由空间中进行传输，介质可以是真空、空气、海水等。
  
  1. 无线电波，信号会向所有方向船舶，因此在有效距离内接收方无需在固定的方向与发送端进行通信，简化了通信连接。穿透性较强可以实现远距离传输，广泛应用于无线局域网、手机通信等。
  
  2. 微波，信号沿直线传输，是视线介质的一种，频段是三者最高的，因此速率最快。应用于卫星通信和地面微波接力通信，应用原理都是通过中继站来转发微波，如只需要3个卫星就能实现全球通信，卫星通信的通信量大、距离远、覆盖广并可以实现广播通信的多址通信，但是时延较长，容易受天气影响，卫星造价贵。
  
  3. 红外线和激光，信号沿直线传输，是视线介质的一种。需要将信号转换为红外光信号/激光信号（而微波不需要转换）

## 7 物理层的设备

（1）中继器

信号在传输的时候会受到干扰而衰减，衰减到一定程度就失真，接收端就无法正确还原数据。为了避免信号衰减，就有了中继器。

中继器的功能是将进行再生和还原，对衰减的信号进行放大来保持与源数据相同或非常接近，从而增加信号传输的距离，延长网络的长度和覆盖范围。

中继器有两个端口，一进一出：

* 两端的网络是网段不是子网，网段必须相同，不会存储转发因此两端网段的协议必须相同，网段的速率必须相同

* 仅作用于信号的电气部分，并不会管错误数据和不适于网段的数据

* 两端的传输介质可以相同，也可以不同

5-4-3规则：

网络标准中对网络延迟范围做了规定，因此中继器只能在规定的范围进行，否额网络会故障。如信号经过非常多的中继器，每个中继器处理的时间加起来就很多，网络延迟就很大。

因此，需要对中继器的使用做限制，在10M以太网中：

* 5：最多不超过5个网段

* 4：5个网段内，最多只能有4个物理层设备

* 3：只有3个端可以连接计算机

（2）集线器

多端口的中继器，星型拓扑结构。在中继器功能基础上，通过连接多台计算机简洁延长了计算机之间的传输距离并扩展网络的长度和范围，再生还原后信号会发送到除输入端口外，且处于工作状态的计算机，因此集线器是广播通信，没有定向传播能力，是一个共享设备。

计算机收到信号后，是给自己的就处理，不是给自己的就丢弃。

由于每台计算机都要发送数据，因此同时发信号可能会产生冲突，遇到冲突就停下，等待一个随机时间后，再各自发送信号，直到没有冲突为止，工作效率比较低。

集线器在同一个时钟周期内只能实现一组通信，若有n台计算机同时发信号，那它们分到的带宽只有1/n的总带宽。

# 七、网络安全
